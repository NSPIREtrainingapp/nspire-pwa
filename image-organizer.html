<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSPIRE Image Organizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            height: calc(100vh - 40px);
            overflow-y: auto;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            background: white;
            padding: 20px;
            z-index: 100;
        }

        .logo {
            max-height: 160px;
            width: auto;
            margin-bottom: 20px;
        }

        .standard-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .standard-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .deficiency-container {
            margin-left: 20px;
        }

        .deficiency-item {
            margin: 10px 0;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 4px;
        }

        .image-preview {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .preview-box {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background: #fff;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            color: #666;
        }

        .preview-box.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #2196f3;
        }

        .preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .preview-box .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: none;
            z-index: 10;
            font-size: 14px;
            line-height: 1;
        }

        .preview-box:hover .remove-btn {
            display: block;
        }

        .hcv-label {
            background-color: #2196f3;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 8px;
            font-size: 0.9em;
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .standard-section {
                padding: 10px;
            }

            .deficiency-container {
                margin-left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="NSPIRE Training App" class="logo">
            <h1>Image Organizer</h1>
            <p>Drag and drop images directly into the boxes below. To resume work from a prior session, click "Load Progress" and select your saved image-assignments.json.</p>
        </div>

        <div id="standardsList"></div>
    </div>

    <script>
        let nspireData = [];
        // Map key format (normalized): `${defId}_${slot}` e.g., "STD-02-1_1"
        // Value can be either a string path or an object { src: dataUrl, filename: string, path?: string }
        let processedImages = new Map();
        let pendingAssignmentsRaw = null; // holds raw assignments to normalize after standards load

        function normalizeAndMergeAssignments(raw) {
            // raw is an object { key: value }
            const entries = Object.entries(raw || {});
            const deferred = [];

            // Helper: slugify string to lower-case underscores without special chars, collapse underscores
            const slugify = (s) => (s || '')
                .toString()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '');

            // Build a lookup of standards by slug of their id and title
            const stdBySlug = new Map();
            if (Array.isArray(nspireData) && nspireData.length) {
                nspireData.forEach(std => {
                    const idSlug = slugify(std.id);
                    stdBySlug.set(idSlug, std);
                    const titleSlug = slugify(std.title);
                    if (titleSlug) stdBySlug.set(titleSlug, std);
                });
            }

            entries.forEach(([key, value]) => {
                let newKey = null;
                // Case 1: Already normalized: `${defId}_${slot}`
                let m = key.match(/^(STD-\d{2}-\d+)_([1-3])$/i);
                if (m) {
                    newKey = `${m[1]}_${m[2]}`;
                }

                // Case 2: Legacy with prefix: `${something}_${defId}_${slot}`
                if (!newKey) {
                    m = key.match(/^[A-Z0-9_\-]+_(STD-\d{2}-\d+)_([1-3])$/i);
                    if (m) newKey = `${m[1]}_${m[2]}`;
                }

                // Case 3: Slug-based: `${standardSlug}_${defNumber}_${slot}` e.g., bathtub_and_shower_1_2
                if (!newKey) {
                    m = key.match(/^([A-Za-z0-9_]+)_([0-9]{1,2})_([1-3])$/);
                    if (m) {
                        const stdSlug = m[1].toLowerCase();
                        const defNum = m[2];
                        const slot = m[3];
                        if (stdBySlug.size) {
                            const std = stdBySlug.get(stdSlug);
                            if (std && Array.isArray(std.deficiencies)) {
                                const def = std.deficiencies.find(d => /-\d+$/.test(d.id) && d.id.endsWith(`-${defNum}`));
                                if (def) newKey = `${def.id}_${slot}`;
                            }
                        } else {
                            // standards not loaded yet; defer
                            deferred.push([key, value]);
                            return;
                        }
                    }
                }

                // If still unknown and standards not loaded, defer; otherwise store as-is to avoid data loss
                if (!newKey) {
                    if (!nspireData.length) {
                        deferred.push([key, value]);
                        return;
                    } else {
                        newKey = key; // last resort
                    }
                }
                processedImages.set(newKey, value);
            });

            if (deferred.length) {
                // Keep a merged copy to retry after standards load
                pendingAssignmentsRaw = Object.assign({}, pendingAssignmentsRaw || {});
                deferred.forEach(([k, v]) => { pendingAssignmentsRaw[k] = v; });
            }
        }
        
        // Load any previously saved assignments (if the JSON exists in the project root)
        fetch('image-assignments.json')
            .then(response => response.ok ? response.json() : Promise.reject())
            .then(data => {
                normalizeAndMergeAssignments(data);
                if (nspireData.length > 0) displayStandards();
            })
            .catch(() => {
                console.log('No previous assignments found in project root. You can load your saved JSON using the Load Progress button.');
            });

    fetch('nspire_standards.json')
            .then(response => response.json())
            .then(data => {
                nspireData = data;
                // If there are any deferred keys, try to normalize again now that standards are loaded
                if (pendingAssignmentsRaw) {
                    normalizeAndMergeAssignments(pendingAssignmentsRaw);
                    pendingAssignmentsRaw = null;
                }
                displayStandards();
            })
            .catch(error => {
                console.error('Error loading NSPIRE data:', error);
                document.getElementById('standardsList').innerHTML = '<div class="error">Error loading standards data</div>';
            });

        function getImageKey(defId, slot) {
            return `${defId}_${slot}`;
        }

        function renderAssignedBox(defId, slot) {
            const key = getImageKey(defId, slot);
            const val = processedImages.get(key);
            if (!val) return '';
            let src = '';
            let filename = '';
            if (typeof val === 'string') {
                src = val; // assume relative path
                filename = val.split('/').pop();
            } else if (val && typeof val === 'object') {
                src = val.src || val.path || '';
                filename = val.filename || '';
            }
            const dataKey = key;
            // Build fallback src candidates in case the saved file was downloaded to root with an underscore prefix
            const base = filename || (src ? src.split('/').pop() : '');
            const candidates = [];
            if (src) candidates.push(src);
            if (base) {
                candidates.push(`images/${base}`);
                candidates.push(`images_${base}`);
                candidates.push(base);
            }
            const first = candidates[0] || '';
            const fallbackAttr = candidates.slice(1).join('|');
            return `
                <div class="preview-box" data-image="${slot}" data-key="${dataKey}">
                    <img src="${first}" alt="${filename}" onerror="fallbackImg(event, '${fallbackAttr}')">
                    <button class="remove-btn" onclick="removeAssigned(event)">×</button>
                </div>
            `;
        }

        function displayStandards() {
            const container = document.getElementById('standardsList');
            container.innerHTML = nspireData.map((standard, standardIndex) => {
                const standardId = standard.id;
                const standardTitle = standard.title || standard.summary || standardId;

                const deficienciesHtml = (standard.deficiencies || []).map((def, defIndex) => {
                    const defId = def.id;
                    // Parse severityCellText for location-based severity labels
                    let locationLabels = '';
                    if (def.severityCellText) {
                        const lines = def.severityCellText.split('\n').filter(l => l.trim());
                        let locationGroups = [];
                        lines.forEach(line => {
                            const sevMatch = line.match(/(LOW|MODERATE|SEVERE|LIFE THREATENING)[^\n]*/i);
                            const locMatch = line.match(/\(([^)]+)\)/);
                            const hcvMatch = line.match(/HCV:\s*(PASS|FAIL)/i);
                            if (sevMatch && locMatch) {
                                const sev = sevMatch[1];
                                const locs = locMatch[1].split(/\s*&\s*|\s*,\s*/);
                                const hcvVal = hcvMatch ? hcvMatch[1].toUpperCase() : (def.hcv || 'FAIL');
                                locs.forEach(loc => {
                                    locationGroups.push({
                                        location: loc.trim(),
                                        severity: sev,
                                        hcv: hcvVal
                                    });
                                });
                            }
                        });
                        if (locationGroups.length > 0) {
                            locationGroups.forEach(group => {
                                locationLabels += `<div><strong>Location:</strong> <span class='area-label'>${group.location}</span> <span class='severity-badge ${group.severity.toLowerCase()}'>${group.severity}</span> <span class='hcv-label'>HCV: ${group.hcv}</span></div>`;
                            });
                        }
                    }
                    // Always show deficiency details and criteria
                    return `
                        <div class="deficiency-item" data-standard="${standardId}" data-deficiency="${defId}">
                            <div class="deficiency-criteria-title">
                                <strong>${def.title || 'Deficiency'}</strong>
                            </div>
                            <div class="deficiency-meta">
                                ${locationLabels || `<div><strong>Location:</strong> <span class='area-label'>${def.location || ''}</span> <span class='severity-badge ${(def.severity || '').toLowerCase()}'>${def.severity || ''}</span> <span class='hcv-label'>HCV: ${def.hcv || 'FAIL'}</span></div>`}
                            </div>
                            <div class="deficiency-details">
                                <div class="details-title">Details</div>
                                <div class="deficiency-text">${def.verbatim || ''}</div>
                            </div>
                            <div class="image-section">
                                <div class="image-section-title">Reference Images:</div>
                                <div class="image-preview" id="${defId}_preview">
                                    ${[1, 2, 3].map(num => {
                                        const key = getImageKey(defId, num);
                                        if (processedImages.has(key)) {
                                            return renderAssignedBox(defId, num);
                                        }
                                        return `
                                            <div class="preview-box" 
                                                 data-image="${num}"
                                                 ondragover="handleDragOver(event)" 
                                                 ondrop="handleDrop(event)" 
                                                 ondragleave="handleDragLeave(event)">
                                                Drag Image ${num} Here
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="standard-section">
                        <div class="standard-title">${standardTitle}</div>
                        <div class="deficiency-container">
                            ${deficienciesHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Add drag and drop event prevention for the container
            document.querySelector('.container').addEventListener('dragover', (e) => {
                e.preventDefault();
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const box = e.currentTarget;
            box.classList.remove('dragover');
            
            if (!box.classList.contains('preview-box')) return;
            
            const items = e.dataTransfer.items;
            if (!items) return;
            
            const imageItem = Array.from(items).find(item => item.kind === 'file' && item.type.startsWith('image/'));
            if (!imageItem) return;
            
            const file = imageItem.getAsFile();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                addImageToBox(box, e.target.result, file.name);
            };
            reader.readAsDataURL(file);
        }

    function addImageToBox(box, imgSrc, filename) {
            if (box.querySelector('img')) return;
            
            const img = document.createElement('img');
            img.src = imgSrc;
            img.setAttribute('data-filename', filename);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = function(e) {
                e.stopPropagation();
        const key = box.dataset.key;
        box.innerHTML = `Drag Image ${box.dataset.image} Here`;
        if (key) processedImages.delete(key);
                saveAssignments();
            };

            box.innerHTML = '';
            box.appendChild(img);
            box.appendChild(removeBtn);
            
            // Save assignments after adding new image
        const deficiencyItem = box.closest('.deficiency-item');
        const defId = deficiencyItem.dataset.deficiency; // already the defId
        const imageKey = getImageKey(defId, box.dataset.image);
        box.dataset.key = imageKey;
            
            // Save the file to the images folder
            const imgCopy = document.createElement('img');
            imgCopy.src = imgSrc;
            
            // Create a canvas to convert the image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            imgCopy.onload = () => {
                canvas.width = imgCopy.width;
                canvas.height = imgCopy.height;
                ctx.drawImage(imgCopy, 0, 0);
                canvas.toBlob((blob) => {
                    // Create a download link for the image
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `images/${filename}`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                });
            };
            
        // Store data URL and filename for reliable reloading; also include suggested project path
        processedImages.set(imageKey, { src: imgSrc, filename, path: `images/${filename}` });
        saveAssignments();
        }

        function saveAssignments() {
            // Convert Map to object for JSON serialization
            const assignmentsObj = Object.fromEntries(processedImages);
            
            // Create a Blob with the JSON data
            const blob = new Blob([JSON.stringify(assignmentsObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const a = document.createElement('a');
            a.href = url;
            a.download = 'image-assignments.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Fallback image loader tries alternate locations if the initial src 404s
        function fallbackImg(e, rest) {
            if (!rest) return;
            const img = e.currentTarget;
            const parts = rest.split('|').filter(Boolean);
            if (!parts.length) return;
            const next = parts.shift();
            img.onerror = () => fallbackImg({ currentTarget: img }, parts.join('|'));
            img.src = next;
        }

        // Support removing assigned image rendered from saved data
        function removeAssigned(e) {
            e.stopPropagation();
            const btn = e.currentTarget;
            const box = btn.closest('.preview-box');
            const key = box?.dataset?.key || '';
            const slot = box?.dataset?.image || '';
            if (key) processedImages.delete(key);
            box.innerHTML = `Drag Image ${slot} Here`;
            box.removeAttribute('data-key');
            // Re-enable DnD on this box
            box.setAttribute('ondragover', 'handleDragOver(event)');
            box.setAttribute('ondrop', 'handleDrop(event)');
            box.setAttribute('ondragleave', 'handleDragLeave(event)');
            saveAssignments();
        }

        // Add save button to header
        const saveButton = document.createElement('button');
        saveButton.innerText = 'Save Progress';
        saveButton.style.marginTop = '10px';
        saveButton.onclick = saveAssignments;
        document.querySelector('.header').appendChild(saveButton);

        // Add load button + hidden file input to header
        const loadInput = document.createElement('input');
        loadInput.type = 'file';
        loadInput.accept = 'application/json';
        loadInput.style.display = 'none';
        loadInput.addEventListener('change', async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                normalizeAndMergeAssignments(data);
                displayStandards();
            } catch (err) {
                alert('Failed to load progress file. Please select a valid image-assignments.json.');
            } finally {
                e.target.value = '';
            }
        });
        document.body.appendChild(loadInput);

        const loadButton = document.createElement('button');
        loadButton.innerText = 'Load Progress';
        loadButton.style.marginTop = '10px';
        loadButton.style.marginLeft = '10px';
        loadButton.onclick = () => loadInput.click();
        document.querySelector('.header').appendChild(loadButton);
    </script>
</body>
</html>
