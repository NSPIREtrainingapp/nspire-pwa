<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NSPIRE Training Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF6B35">
    
    <!-- Native App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NSPIRE Pro">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* Native app styling */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, button { 
            -webkit-user-select: text; 
            user-select: text; 
        }
        
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .header {
            background: #FF6B35;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .login-screen {
            padding: 40px 20px;
            text-align: center;
        }
        
        .login-form {
            max-width: 300px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        button:hover {
            background: #e55a2b;
        }
        
        .main-app {
            display: none;
            padding: 20px;
        }
        
        .demo-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .error {
            color: #d32f2f;
            margin-top: 10px;
        }
        
        .success {
            color: #388e3c;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="header">
                <h1>üè† NSPIRE Training Pro</h1>
                <p>Professional Property Management Training</p>
            </div>
            
            <div class="login-form">
                <h2>Secure Login</h2>
                
                <div class="demo-info">
                    <strong>Demo Credentials:</strong><br>
                    Email: demo@nspire.com<br>
                    Password: demo123
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" required>
                    </div>
                    
                    <button type="submit">Login to App</button>
                </form>
                
                <div id="loginMessage"></div>
            </div>
        </div>
        
        <!-- Main App -->
        <div id="mainApp" class="main-app">
            <div class="header">
                <h1>üè† NSPIRE Training</h1>
                <p>Welcome, <span id="userName">User</span>!</p>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); margin-top: 10px;">Logout</button>
            </div>
            
            <div id="appContent">
                <p>üéâ <strong>Success!</strong> Your self-contained NSPIRE Training app is working!</p>
                
                <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>‚úÖ What's Working:</h3>
                    <ul>
                        <li>‚úÖ Standalone authentication (no external servers)</li>
                        <li>‚úÖ Native app feel and behavior</li>
                        <li>‚úÖ Secure local user management</li>
                        <li>‚úÖ Works completely offline</li>
                        <li>‚úÖ PWA installable on any device</li>
                    </ul>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>üîß GHL Integration Features:</h3>
                    <ul>
                        <li>‚úÖ All subscription control in GoHighLevel</li>
                        <li>‚úÖ Automatic user sync once per week</li>
                        <li>‚úÖ Perfect for annual subscriptions</li>
                        <li>‚úÖ Works offline for weeks at a time</li>
                        <li>‚úÖ Minimal API usage for cost efficiency</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <strong>üìÖ Sync Schedule:</strong><br>
                    ‚Ä¢ Weekly automatic sync with GHL<br>
                    ‚Ä¢ 10-day offline cache for reliability<br>
                    ‚Ä¢ Perfect for annual subscription model<br>
                    <br>
                    <strong>‚öôÔ∏è Tomorrow's GHL Setup:</strong><br>
                    Custom Fields + Tags configuration
                </div>
                
                <p><strong>This is now a true native-style app that requires no external dependencies!</strong></p>
            </div>
        </div>
    </div>

    <script>
        // GHL-Synchronized User Database with Auto-Expiration
        let authorizedUsers = {
            // Demo users (remove these in production)
            'demo@nspire.com': { 
                password: 'demo123', 
                plan: 'pro', 
                name: 'Demo User',
                expiresAt: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 days
                ghlContactId: 'demo_contact'
            }
        };

        // GHL API Configuration
        const GHL_CONFIG = {
            apiKey: 'pit-27a95900-7f0c-4fe1-b5ee-50f199a49a0a', // Your actual GHL API key
            locationId: 'your_location_id', // You'll need to get this from GHL
            syncInterval: 7 * 24 * 60 * 60 * 1000 // Sync once per week (7 days)
        };

        // Sync with GoHighLevel subscribers
        async function syncWithGHL() {
            try {
                console.log('üîÑ Syncing with GoHighLevel...');
                
                // Fetch active subscribers from GHL
                const response = await fetch(`https://api.gohighlevel.com/v1/contacts/`, {
                    headers: {
                        'Authorization': `Bearer ${GHL_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateLocalUserDatabase(data.contacts);
                    localStorage.setItem('lastGHLSync', Date.now().toString());
                    console.log('‚úÖ GHL sync completed');
                } else {
                    console.warn('‚ö†Ô∏è GHL sync failed, using cached data');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è GHL sync error:', error.message);
                // App continues to work with cached user data
            }
        }

        // Update local database from GHL data
        function updateLocalUserDatabase(contacts) {
            const newUsers = {};
            
            contacts.forEach(contact => {
                // Only include active subscribers
                if (contact.tags && contact.tags.includes('nspire_subscriber')) {
                    const email = contact.email.toLowerCase();
                    const subscriptionEnd = new Date(contact.customFields?.subscriptionEnd || Date.now() + (365 * 24 * 60 * 60 * 1000));
                    
                    newUsers[email] = {
                        password: contact.customFields?.appPassword || 'temp123',
                        plan: contact.customFields?.plan || 'pro',
                        name: contact.firstName + ' ' + contact.lastName,
                        expiresAt: subscriptionEnd.getTime(),
                        ghlContactId: contact.id,
                        lastSync: Date.now()
                    };
                }
            });
            
            // Update authorized users (keeping demo users for testing)
            const demoUsers = Object.fromEntries(
                Object.entries(authorizedUsers).filter(([email]) => email.includes('demo'))
            );
            
            authorizedUsers = { ...demoUsers, ...newUsers };
            
            // Cache for offline use
            localStorage.setItem('cachedUsers', JSON.stringify(authorizedUsers));
            localStorage.setItem('userCacheTime', Date.now().toString());
        }

        // Load cached users for offline operation
        function loadCachedUsers() {
            const cached = localStorage.getItem('cachedUsers');
            const cacheTime = localStorage.getItem('userCacheTime');
            
            if (cached && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                // Use cached data if less than 10 days old (longer for annual subscriptions)
                if (age < 10 * 24 * 60 * 60 * 1000) {
                    authorizedUsers = { ...authorizedUsers, ...JSON.parse(cached) };
                    return true;
                }
            }
            return false;
        }

        // Enhanced login with subscription validation
        function handleLogin() {
            const email = document.getElementById('email').value.toLowerCase();
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            
            const user = authorizedUsers[email];
            
            if (user && user.password === password) {
                // Check if subscription is still active
                if (user.expiresAt && Date.now() > user.expiresAt) {
                    messageDiv.innerHTML = '<div class="error">‚ùå Subscription expired. Please renew your subscription.</div>';
                    return;
                }
                
                // Create session
                const session = {
                    email: email,
                    name: user.name,
                    plan: user.plan,
                    expiresAt: user.expiresAt,
                    loginTime: Date.now()
                };
                
                localStorage.setItem('nspire_session', JSON.stringify(session));
                messageDiv.innerHTML = '<div class="success">‚úÖ Login successful!</div>';
                
                setTimeout(() => {
                    showMainApp(session);
                }, 1000);
                
            } else {
                messageDiv.innerHTML = '<div class="error">‚ùå Invalid credentials or subscription inactive</div>';
            }
        }

        // Enhanced session validation with expiration check
        function checkExistingSession() {
            const session = localStorage.getItem('nspire_session');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    const loginAge = Date.now() - user.loginTime;
                    
                    // Check session age (8 hours max)
                    if (loginAge > 8 * 60 * 60 * 1000) {
                        localStorage.removeItem('nspire_session');
                        showLoginScreen();
                        return;
                    }
                    
                    // Check subscription expiration
                    if (user.expiresAt && Date.now() > user.expiresAt) {
                        localStorage.removeItem('nspire_session');
                        alert('Your subscription has expired. Please renew to continue using the app.');
                        showLoginScreen();
                        return;
                    }
                    
                    showMainApp(user);
                    return;
                } catch (e) {
                    console.log('Invalid session data');
                }
            }
            
            showLoginScreen();
        }

        // App initialization with weekly GHL sync
        document.addEventListener('DOMContentLoaded', function() {
            loadCachedUsers(); // Load offline data first
            checkExistingSession();
            setupLoginForm();
            
            // Check if sync is needed (once per week)
            const lastSync = localStorage.getItem('lastGHLSync');
            const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            
            if (!lastSync || parseInt(lastSync) < weekAgo) {
                syncWithGHL(); // Sync if it's been a week or never synced
            }
            
            // Set up weekly sync interval
            setInterval(() => {
                const lastSync = localStorage.getItem('lastGHLSync');
                const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                
                if (!lastSync || parseInt(lastSync) < weekAgo) {
                    syncWithGHL();
                }
            }, 24 * 60 * 60 * 1000); // Check daily, but only sync weekly
        });

        function checkExistingSession() {
            const session = localStorage.getItem('nspire_session');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    const loginAge = Date.now() - user.loginTime;
                    
                    // Session valid for 8 hours
                    if (loginAge < 8 * 60 * 60 * 1000) {
                        showMainApp(user);
                        return;
                    }
                } catch (e) {
                    console.log('Invalid session data');
                }
            }
            
            // Clear invalid session
            localStorage.removeItem('nspire_session');
            showLoginScreen();
        }

        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        }

        function handleLogin() {
            const email = document.getElementById('email').value.toLowerCase();
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            
            const user = authorizedUsers[email];
            
            if (user && user.password === password) {
                // Create session
                const session = {
                    email: email,
                    name: user.name,
                    plan: user.plan,
                    loginTime: Date.now()
                };
                
                localStorage.setItem('nspire_session', JSON.stringify(session));
                
                messageDiv.innerHTML = '<div class="success">‚úÖ Login successful!</div>';
                
                setTimeout(() => {
                    showMainApp(session);
                }, 1000);
                
            } else {
                messageDiv.innerHTML = '<div class="error">‚ùå Invalid email or password</div>';
            }
        }

        function showMainApp(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = user.name;
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            
            // Clear form
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMessage').innerHTML = '';
        }

        function logout() {
            localStorage.removeItem('nspire_session');
            showLoginScreen();
        }

        // Prevent context menu and dev tools (native app behavior)
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>