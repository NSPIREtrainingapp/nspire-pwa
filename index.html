<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NSPIRE Training Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF6B35">
    
    <!-- Native App Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name        // App initialization - manual users only
        document.addEventListener('DOMContentLoaded', function() {
            loadCachedUsers(); // Load offline data first
            checkExistingSession();
            setupLoginForm();
            
            console.log('‚úÖ App loaded with manual user database');
            console.log('üë• Available users:', Object.keys(authorizedUsers));
            console.log('üîç Full user data:', authorizedUsers);
            
            // Weekly sync removed due to CORS - using manual user management
        });

        function checkExistingSession() {ole.log('‚úÖ App loaded with manual user database');
            console.log('üë• Available users:', Object.keys(authorizedUsers));
            
            // Weekly sync removed due to CORS - using manual user management
        });le-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NSPIRE Pro">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* Native app styling */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, button { 
            -webkit-user-select: text; 
            user-select: text; 
        }
        
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            color: black;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .login-screen {
            padding: 40px 20px;
            text-align: center;
        }
        
        .login-form {
            max-width: 300px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #007BFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .main-app {
            display: none;
            padding: 20px;
        }
        
        .error {
            color: #d32f2f;
            margin-top: 10px;
        }
        
        .success {
            color: #388e3c;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="header">
                <img src="logo.png" alt="NSPIRE Training App" class="logo" style="max-width: 200px; height: auto;">
            </div>
            
            <div class="login-form">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input type="password" id="password" required>
                    </div>
                    
                    <button type="submit">LOGIN</button>
                </form>
                
                <div id="loginMessage"></div>
            </div>
        </div>
        
        <!-- PWA Install Banner -->
        <div id="installBanner" style="
            background: linear-gradient(135deg, #007BFF, #0056b3);
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        ">
            <button id="installButton" style="
                background: white;
                color: #007BFF;
                border: none;
                padding: 15px 30px;
                border-radius: 5px;
                font-weight: bold;
                font-size: 16px;
                cursor: pointer;
            ">INSTALL APP</button>
        </div>
        
        <!-- Main App -->
        <div id="mainApp" class="main-app">
            <div class="header">
                <h1>üè† NSPIRE Training</h1>
                <p>Welcome, <span id="userName">User</span>!</p>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); margin-top: 10px;">Logout</button>
            </div>
            
            <div id="appContent">
                <p>üéâ <strong>Success!</strong> Your self-contained NSPIRE Training app is working!</p>
                
                <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>‚úÖ What's Working:</h3>
                    <ul>
                        <li>‚úÖ Standalone authentication (no external servers)</li>
                        <li>‚úÖ Native app feel and behavior</li>
                        <li>‚úÖ Secure local user management</li>
                        <li>‚úÖ Works completely offline</li>
                        <li>‚úÖ PWA installable on any device</li>
                    </ul>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>üîß GHL Integration Features:</h3>
                    <ul>
                        <li>‚úÖ All subscription control in GoHighLevel</li>
                        <li>‚úÖ Automatic user sync once per week</li>
                        <li>‚úÖ Perfect for annual subscriptions</li>
                        <li>‚úÖ Works offline for weeks at a time</li>
                        <li>‚úÖ Minimal API usage for cost efficiency</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <strong>üìÖ Sync Schedule:</strong><br>
                    ‚Ä¢ Weekly automatic sync with GHL<br>
                    ‚Ä¢ 10-day offline cache for reliability<br>
                    ‚Ä¢ Perfect for annual subscription model<br>
                    <br>
                    <strong>‚öôÔ∏è Tomorrow's GHL Setup:</strong><br>
                    Custom Fields + Tags configuration
                </div>
                
                <p><strong>This is now a true native-style app that requires no external dependencies!</strong></p>
            </div>
        </div>
    </div>

    <script>
        // Manual User Database (no GHL sync due to CORS)
        let authorizedUsers = {
            'nspiretrainingapp@gmail.com': {
                password: '1234',
                plan: 'trial_active',
                name: 'Test User',
                expiresAt: Date.now() + (14 * 24 * 60 * 60 * 1000), // 14 days
                ghlContactId: 'manual_entry'
            }
        };

        // GHL API Configuration
        const GHL_CONFIG = {
            apiKey: 'pit-27a95900-7f0c-4fe1-b5ee-50f199a49a0a', // Your actual GHL API key
            locationId: 'QPG7wp7xYyeZidGPH0JV', // Your GHL Location ID
            syncInterval: 7 * 24 * 60 * 60 * 1000 // Sync once per week (7 days)
        };

        // Sync with GoHighLevel subscribers
        async function syncWithGHL() {
            try {
                console.log('üîÑ Syncing with GoHighLevel...');
                console.log('üìç Location ID:', GHL_CONFIG.locationId);
                console.log('üîë API Key:', GHL_CONFIG.apiKey.substring(0, 10) + '...');
                
                // Try GHL v1 API with your specific location
                const response = await fetch(`https://services.leadconnectorhq.com/v1/contacts?locationId=${GHL_CONFIG.locationId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${GHL_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ Raw GHL Response:', data);
                    updateLocalUserDatabase(data.contacts || []);
                    localStorage.setItem('lastGHLSync', Date.now().toString());
                    
                    // Count users by pricing tier
                    const usersByTier = Object.values(authorizedUsers).reduce((acc, user) => {
                        if (!user.email || user.email.includes('demo')) return acc;
                        acc[user.plan] = (acc[user.plan] || 0) + 1;
                        return acc;
                    }, {});
                    
                    console.log(`‚úÖ GHL sync completed - Found ${data.contacts?.length || 0} contacts`);
                    console.log(`üìä Active users: Trial: ${usersByTier.trial || 0}, Legacy $39: ${usersByTier.legacy_39 || 0}, Standard $59: ${usersByTier.standard_59 || 0}`);
                } else {
                    console.error('‚ùå GHL API Error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('‚ùå Error details:', errorText);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è GHL sync error:', error.message);
                // App continues to work with cached user data
            }
        }

        // Update local database from GHL data
        function updateLocalUserDatabase(contacts) {
            const newUsers = {};
            
            console.log('üîç Processing contacts:', contacts?.length || 0);
            
            contacts.forEach((contact, index) => {
                console.log(`üë§ Contact ${index + 1}:`, {
                    email: contact.email,
                    tags: contact.tags,
                    customFields: contact.customFields
                });
                
                // Check for required tags (trial_active, standard_59, or legacy_39)
                const hasValidTag = contact.tags && (
                    contact.tags.includes('trial_active') || 
                    contact.tags.includes('standard_59') || 
                    contact.tags.includes('legacy_39')
                );
                
                if (hasValidTag && contact.email) {
                    const email = contact.email.toLowerCase();
                    
                    // Determine subscription type and pricing
                    let plan = 'trial';
                    let subscriptionEnd;
                    
                    if (contact.tags.includes('trial_active')) {
                        plan = 'trial_active';
                        subscriptionEnd = new Date(Date.now() + (14 * 24 * 60 * 60 * 1000)); // 14 days
                    } else if (contact.tags.includes('legacy_39')) {
                        plan = 'legacy_39';
                        subscriptionEnd = new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)); // 1 year
                    } else if (contact.tags.includes('standard_59')) {
                        plan = 'standard_59';
                        subscriptionEnd = new Date(Date.now() + (365 * 24 * 60 * 60 * 1000)); // 1 year
                    }
                    
                    newUsers[email] = {
                        password: contact.customFields?.app_password || 'nspire123',
                        plan: plan,
                        name: (contact.firstName || '') + ' ' + (contact.lastName || ''),
                        expiresAt: subscriptionEnd.getTime(),
                        ghlContactId: contact.id,
                        lastSync: Date.now(),
                        appUserId: contact.customFields?.app_user_id || contact.id,
                        subscriberNumber: contact.customFields?.subscriber_number
                    };
                    
                    console.log(`‚úÖ Added user: ${email} (${plan})`);
                } else {
                    console.log(`‚ùå Skipped contact: ${contact.email || 'no email'} - Missing required tags`);
                }
            });
            
            // Update authorized users 
            authorizedUsers = { ...newUsers };
            
            // Cache for offline use
            localStorage.setItem('cachedUsers', JSON.stringify(authorizedUsers));
            localStorage.setItem('userCacheTime', Date.now().toString());
            
            console.log('üìä Total authorized users:', Object.keys(authorizedUsers).length);
        }

        // Load cached users for offline operation
        function loadCachedUsers() {
            const cached = localStorage.getItem('cachedUsers');
            const cacheTime = localStorage.getItem('userCacheTime');
            
            if (cached && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                // Use cached data if less than 10 days old (longer for annual subscriptions)
                if (age < 10 * 24 * 60 * 60 * 1000) {
                    authorizedUsers = { ...authorizedUsers, ...JSON.parse(cached) };
                    return true;
                }
            }
            return false;
        }

        // Enhanced login with Netlify Function + GHL integration
        function handleLogin() {
            const email = document.getElementById('email').value.toLowerCase();
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');
            
            if (!email || !password) {
                messageDiv.innerHTML = '<div class="error">‚ùå Please enter email and password</div>';
                return;
            }

            messageDiv.innerHTML = '<div style="color: #007BFF;">üîÑ Verifying with GoHighLevel...</div>';
            
            // Call Netlify Function for GHL authentication
            fetch('/.netlify/functions/ghl-auth', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user) {
                    // Create session with GHL data
                    const session = {
                        email: data.user.email,
                        name: data.user.name,
                        plan: data.user.plan,
                        expiresAt: data.user.expiresAt,
                        loginTime: Date.now(),
                        ghlContactId: data.user.ghlContactId
                    };
                    
                    localStorage.setItem('nspire_session', JSON.stringify(session));
                    messageDiv.innerHTML = '<div class="success">‚úÖ Login successful!</div>';
                    
                    console.log('‚úÖ GHL Authentication successful:', data.user);
                    
                    setTimeout(() => {
                        showMainApp(session);
                    }, 1000);
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå ${data.error || 'Authentication failed'}</div>`;
                    console.log('‚ùå GHL Authentication failed:', data.error);
                }
            })
            .catch(error => {
                console.error('‚ùå Authentication error:', error);
                messageDiv.innerHTML = '<div class="error">‚ùå Connection error. Please try again.</div>';
            });
        }
        }

        // Enhanced session validation with expiration check
        function checkExistingSession() {
            const session = localStorage.getItem('nspire_session');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    const loginAge = Date.now() - user.loginTime;
                    
                    // Check session age (8 hours max)
                    if (loginAge > 8 * 60 * 60 * 1000) {
                        localStorage.removeItem('nspire_session');
                        showLoginScreen();
                        return;
                    }
                    
                    // Check subscription expiration
                    if (user.expiresAt && Date.now() > user.expiresAt) {
                        localStorage.removeItem('nspire_session');
                        alert('Your subscription has expired. Please renew to continue using the app.');
                        showLoginScreen();
                        return;
                    }
                    
                    showMainApp(user);
                    return;
                } catch (e) {
                    console.log('Invalid session data');
                }
            }
            
            showLoginScreen();
        }

        // App initialization - manual users only
        document.addEventListener('DOMContentLoaded', function() {
            loadCachedUsers(); // Load offline data first
            checkExistingSession();
            setupLoginForm();
            
            console.log('‚úÖ App loaded with manual user database');
            console.log('ÔøΩ Available users:', Object.keys(authorizedUsers));
            
            // Weekly sync removed due to CORS - using manual user management
        });

        function checkExistingSession() {
            const session = localStorage.getItem('nspire_session');
            if (session) {
                try {
                    const user = JSON.parse(session);
                    const loginAge = Date.now() - user.loginTime;
                    
                    // Session valid for 8 hours
                    if (loginAge < 8 * 60 * 60 * 1000) {
                        showMainApp(user);
                        return;
                    }
                } catch (e) {
                    console.log('Invalid session data');
                }
            }
            
            // Clear invalid session
            localStorage.removeItem('nspire_session');
            showLoginScreen();
        }

        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
        }

        function showMainApp(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = user.name;
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            
            // Clear form
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMessage').innerHTML = '';
        }

        function logout() {
            localStorage.removeItem('nspire_session');
            showLoginScreen();
        }

        // Prevent context menu (but allow dev tools for debugging)
        document.addEventListener('contextmenu', e => e.preventDefault());
        // Temporarily disabled F12 blocking for debugging
        // document.addEventListener('keydown', function(e) {
        //     if (e.key === 'F12' || (e.ctrlKey && e.key === 'u')) {
        //         e.preventDefault();
        //     }
        // });

        // PWA Installation - HONEST VERSION
        let deferredPrompt;
        const installBanner = document.getElementById('installBanner');
        const installButton = document.getElementById('installButton');

        // Only show banner if browser actually supports auto-install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBanner.style.display = 'block';
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('App installed!');
                    installBanner.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Check if already installed
        window.addEventListener('appinstalled', () => {
            installBanner.style.display = 'none';
            console.log('PWA was installed');
        });

        // Show manual install instructions for iOS
        if (/iPhone|iPad|iPod/.test(navigator.userAgent) && !window.navigator.standalone) {
            setTimeout(() => {
                alert('üì± To install NSPIRE Training as an app:\n\n1. Tap the Share button ‚¨ÜÔ∏è\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" in the top right');
            }, 3000);
        }
    </script>
</body>
</html>