<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NSPIRE Training App</title>
    <!-- Manifest removed to prevent PWA notifications -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <meta name="theme-color" content="#FF6B35">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        /* Import Inter font for better typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Enhanced design system */
        :root {
            /* Color palette - cohesive design system */
            --primary-color: #FF6B35;
            --primary-light: #FF8A5C;
            --primary-dark: #E55A2B;
            --secondary-color: #2563EB;
            --secondary-light: #3B82F6;
            --secondary-dark: #1D4ED8;
            --neutral-50: #F9FAFB;
            --neutral-100: #F3F4F6;
            --neutral-200: #E5E7EB;
            --neutral-300: #D1D5DB;
            --neutral-600: #4B5563;
            --neutral-700: #374151;
            --neutral-800: #1F2937;
            --neutral-900: #111827;
            
            /* Typography scale */
            --font-family-headings: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-family-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            --font-size-xs: 14px;
            --font-size-sm: 16px;
            --font-size-base: 18px;
            --font-size-lg: 20px;
            --font-size-xl: 24px;
            --font-size-2xl: 28px;
            
            /* Consistent spacing */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Consistent border radius */
            --border-radius-sm: 6px;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.06);
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-body);
            font-size: var(--font-size-base);
            line-height: 1.6;
            background: var(--neutral-50);
            min-height: 100vh;
            color: var(--neutral-800);
        }

        .container {
            max-width: 600px; /* Responsive instead of fixed 480px */
            width: 100%;
            margin: 0 auto;
            background: #FEFEFE; /* Slightly off-white instead of pure white */
            min-height: 100vh;
            box-shadow: var(--shadow-lg);
        }

        .header {
            background: #FEFEFE;
            padding: var(--spacing-lg);
            text-align: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* PWA Install Button */
        .install-banner {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            position: absolute;
            top: -9999px;
            pointer-events: none;
        }

        .install-banner.show {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-text {
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
        }

        .install-button {
            background: white;
            color: var(--primary-color);
            border: none;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            margin-right: var(--spacing-sm);
            transition: all 0.2s ease;
        }

        .install-button:hover {
            background: var(--neutral-100);
            transform: translateY(-1px);
        }

        .dismiss-button {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dismiss-button:hover {
            background: rgba(255,255,255,0.1);
        }

        .logo {
            max-height: 160px;
            width: auto;
            display: inline-block;
        }

        /* Typography improvements */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-family-headings);
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: var(--spacing-md);
            color: var(--neutral-900);
        }

        h1 { font-size: var(--font-size-2xl); }
        h2 { font-size: var(--font-size-xl); }
        h3 { font-size: var(--font-size-lg); }
        h4 { font-size: var(--font-size-base); font-weight: 500; }

        p, li {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-sm);
        }

        .page {
            display: none;
            padding: var(--spacing-lg); /* Increased padding for better mobile experience */
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Login Page */
        .login-form {
            margin-top: 50px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #FF6B35;
        }

        /* Enhanced button system */
        .btn {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            min-height: 48px; /* Better touch target */
        }

        .btn:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* Secondary button style */
        .btn-secondary {
            background: transparent;
            color: var(--secondary-color);
            border: 2px solid var(--secondary-color);
        }

        .btn-secondary:hover {
            background: var(--secondary-color);
            color: white;
        }

        .link {
            text-align: center;
            margin-top: var(--spacing-lg);
            color: var(--secondary-color);
            cursor: pointer;
            font-size: var(--font-size-sm);
        }
        
        /* License Activation Styles */
        .license-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .activation-methods {
            margin-bottom: 20px;
        }
        
        .method-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }
        
        .method-tab {
            flex: 1;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .method-tab.active {
            background: var(--primary-color);
            color: white;
        }
        
        .activation-method {
            display: none;
        }
        
        .activation-method.active {
            display: block;
        }
        
        .license-input {
            font-family: 'Courier New', monospace !important;
            letter-spacing: 1px;
            text-align: center;
        }
        
        .qr-scanner-container {
            position: relative;
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .qr-frame {
            width: 200px;
            height: 200px;
            border: 3px solid var(--primary-color);
            border-radius: 8px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
        }
        
        .license-message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        .license-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .license-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .license-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        .purchase-links {
            margin-top: 30px;
            text-align: center;
        }
        
        .license-status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .license-status .status-title {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }
        
        .license-status .status-details {
            font-size: 14px;
            color: #555;
        }
        
        .license-status-compact {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            padding: 6px 12px;
            border-radius: 4px;
            margin: 8px 0;
            text-align: center;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        /* Search Page improvements */
        .search-container {
            position: sticky;
            top: 90px;
            background: #FEFEFE;
            z-index: 99;
            padding: var(--spacing-md) var(--spacing-lg) var(--spacing-lg);
            border-bottom: 1px solid var(--neutral-200);
        }

        .search-box {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--neutral-300);
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            transition: border-color 0.2s ease;
            min-height: 48px; /* Better touch target */
            background: white;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .standards-list {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .standard-item {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }

        .standard-item:hover {
            background: #f8f8f8;
            padding-left: 25px;
        }

        .standard-title {
            font-size: 16px;
            color: #007AFF;
            font-weight: 500;
        }

        /* Enhanced navigation */
        .back-button {
            padding: var(--spacing-sm) var(--spacing-lg);
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-base);
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
            min-height: 44px; /* Better touch target */
        }

        .back-button:hover {
            background: var(--secondary-dark);
            box-shadow: var(--shadow);
        }

        .deficiency-header {
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .deficiency-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .deficiency-meta {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .deficiency-item {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .deficiency-criteria-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        /* Severity Badges */
        .severity-container {
            margin-bottom: 15px;
        }

        .severity-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
        }

        .severity-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Enhanced color-coded text with better contrast and accessibility */
        .severity-text-low {
            color: #16a34a; /* Darker green for better contrast */
            background: #f0fdf4;
            padding: 2px 6px; /* Minimal padding to just frame the text */
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            border: 1px solid #bbf7d0;
            display: inline-block;
            margin-right: 4px; /* Small margin to prevent overlap */
        }
        
        .severity-text-moderate {
            color: #ca8a04; /* Darker yellow for better contrast */
            background: #fffbeb;
            padding: 2px 6px; /* Minimal padding to just frame the text */
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            border: 1px solid #fde68a;
            display: inline-block;
            margin-right: 4px; /* Small margin to prevent overlap */
        }
        
        .severity-text-severe {
            color: #dc2626; /* Darker red for better contrast */
            background: #fef2f2;
            padding: 2px 6px; /* Minimal padding to just frame the text */
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            border: 1px solid #fecaca;
            display: inline-block;
            margin-right: 4px; /* Small margin to prevent overlap */
        }
        
        .severity-text-life-threatening {
            color: #dc2626; /* Darker red for better contrast */
            background: #fef2f2;
            padding: 2px 6px; /* Minimal padding to just frame the text */
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            border: 1px solid #fecaca;
            display: inline-block;
            margin-right: 4px; /* Small margin to prevent overlap */
        }
        
        .hcv-text-pass {
            color: #16a34a; /* Darker green for better contrast */
            background: #f0fdf4;
            padding: 2px 6px; /* Minimal padding to just frame the text */
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            border: 1px solid #bbf7d0;
            display: inline-block;
            margin-right: 4px; /* Small margin to prevent overlap */
        }
        
        .hcv-text-fail {
            color: #dc2626; /* Darker red for better contrast */
            background: #fef2f2;
            padding: 2px 6px; /* Minimal padding to just frame the text */
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            border: 1px solid #fecaca;
            display: inline-block;
            margin-right: 4px; /* Small margin to prevent overlap */
        }

        .severity-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .severity-life-threatening {
            background: #d32f2f;
            color: white;
        }

        .severity-severe {
            background: #f57c00;
            color: white;
        }

        .severity-moderate {
            background: #fbc02d;
            color: #333;
        }

        .severity-low {
            background: #689f38;
            color: white;
        }

        .hcv-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: auto;
            display: inline-block;
            min-width: 90px;
            text-align: center;
        }

        .hcv-fail {
            background: #d32f2f;
            color: white;
        }

        .hcv-pass {
            background: #4caf50;
            color: white;
        }

        .area-label {
            color: #666;
            font-size: 12px;
            font-style: italic;
        }

        .deficiency-details {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .details-title {
            color: #1976d2;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .deficiency-text {
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            white-space: pre-wrap;
        }

        .correction-timeframe {
            background: #fff3e0;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: 500;
            color: #e65100;
        }

        .image-section {
            margin-top: 20px;
        }

        .image-section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #666;
        }

        .image-gallery {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .image-placeholder {
            width: 100px;
            height: 100px;
            background: #f0f0f0;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }

        .image-placeholder.assigned {
            border: 2px solid #28a745;
            background: #fff;
        }

        .image-placeholder.assigned:hover {
            border-color: #218838;
            transform: scale(1.05);
        }

        .image-placeholder.empty {
            border: 2px dashed #ddd;
        }

        .image-placeholder.empty:hover {
            background: #e8e8e8;
            border-color: #FF6B35;
        }

        .image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-modal.active {
            display: flex;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .modal-image {
            width: 100%;
            height: auto;
            display: block;
            max-height: 85vh;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: white;
            font-size: 35px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        /* Weighted score UI */
        .units-row {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .units-row label {
            font-size: 14px;
            color: #333;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .units-input-compact {
            width: 80px;
            padding: 8px 10px;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            font-weight: 600;
            transition: border-color 0.2s ease;
        }
        
        .units-input-compact:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        .sample-size-inline {
            background: var(--neutral-100);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--neutral-700);
            white-space: nowrap;
        }
        /* Enhanced form controls */
        .units-input {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--neutral-300);
            border-radius: var(--border-radius);
            font-size: var(--font-size-base);
            transition: border-color 0.2s ease;
            min-height: 48px; /* Better touch target */
            background: white;
        }
        
        .units-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        /* Improved information cards */
        .weighted-badge {
            background: var(--neutral-100);
            color: var(--neutral-800);
            border-radius: var(--border-radius);
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
            display: inline-block;
            margin-left: var(--spacing-xs);
            border: 1px solid var(--neutral-200);
        }
        
        .points-lost {
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .points-lost-inline {
            margin-left: 10px;
            font-size: 0.85em;
        }
        
        .points-lost .weighted-badge {
            background: #dc3545;
            color: white;
        }
        
        .points-lost-inline .weighted-badge {
            background: #dc3545;
            color: white;
        }
        
        /* Enhanced sample size display as card */
        .sample-size-note {
            font-size: var(--font-size-base);
            color: var(--neutral-700);
            margin-top: var(--spacing-md);
            display: block;
            text-align: center;
            width: 100%;
            background: var(--neutral-100);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--neutral-200);
            font-weight: 500;
        }
        .loc-score-badge {
            background: #fff59d;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="logo.png?v=1" alt="NSPIRE Training App" class="logo">
            <button id="logoutButton" onclick="handleLogout()" style="
                position: absolute;
                top: 16px;
                right: 16px;
                background: #ef4444;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
                display: none;
                transition: background 0.2s ease;
            " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                Logout
            </button>
        </div>

        <!-- PWA Install Banner - COMPLETELY REMOVED -->
        <!-- Banner HTML removed to prevent all notifications -->

        <!-- License Activation Page -->
        <div id="loginPage" class="page active">
            <div class="license-form">
                <div class="activation-methods">
                    <div class="method-tabs">
                        <button class="method-tab active" onclick="showActivationMethod('key')">Enter License Key</button>
                        <button class="method-tab" onclick="showActivationMethod('qr')">Scan QR Code</button>
                    </div>
                    
                    <!-- License Key Input -->
                    <div id="keyMethod" class="activation-method active">
                        <div class="form-group">
                            <label class="form-label">License Key</label>
                            <input type="text" id="licenseKeyInput" class="form-input license-input" 
                                   placeholder="NSPIRE-2025-XXXX-XXXX-XXXX" 
                                   pattern="NSPIRE-\d{4}-[A-Z0-9]{4,6}-[A-Z0-9]{4,6}-[A-Z0-9]{4,6}"
                                   style="font-family: monospace; text-transform: uppercase;">
                        </div>
                        <button type="button" class="btn" onclick="activateLicense()">Activate License</button>
                    </div>
                    
                    <!-- QR Scanner -->
                    <div id="qrMethod" class="activation-method">
                        <div class="qr-scanner-container">
                            <video id="qrVideo" style="width: 100%; max-width: 300px; border-radius: 8px;"></video>
                            <canvas id="qrCanvas" style="display: none;"></canvas>
                            <div class="qr-overlay">
                                <div class="qr-frame"></div>
                                <p style="color: white; margin-top: 10px;">Position QR code within frame</p>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="startQRScanner()">Start Camera</button>
                        <button type="button" class="btn btn-secondary" onclick="stopQRScanner()">Stop Camera</button>
                    </div>
                </div>
                
                <div id="licenseMessage" class="license-message"></div>
                
                <div class="purchase-links">
                    <div class="link" onclick="renewLicense()" style="font-size: 16px; font-weight: 600; color: var(--primary-color);">
                        RENEW YOUR LICENSE
                    </div>
                </div>
            </div>
        </div>

        <!-- Standards Search Page -->
        <div id="searchPage" class="page">
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" 
                       placeholder="Search standards or deficiencies..." 
                       oninput="filterStandards()">
                <div class="units-row">
                    <label for="unitsInput">Total Units on Property</label>
                    <input id="unitsInput" class="units-input-compact" type="number" min="1" max="9999" step="1" placeholder="100">
                    <div id="sampleSizeNote" class="sample-size-inline">Sample Size: --</div>
                </div>
            </div>
            <div id="standardsList" class="standards-list">
                <div class="loading">Loading standards...</div>
            </div>
        </div>

        <!-- Deficiency Details Page -->
        <div id="detailsPage" class="page">
            <div style="position:sticky;top:175px;z-index:101;background:white;padding-top:10px;">
                <button class="back-button" onclick="showSearchPage()">‚Üê Back to Standards</button>
            </div>
            <div id="deficiencyDetails"></div>
        </div>

        <!-- Image Modal -->
        <div id="imageModal" class="image-modal" onclick="closeImageModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <span class="modal-close" onclick="closeImageModal()">&times;</span>
                <img id="modalImage" class="modal-image" src="" alt="Deficiency Image">
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // NSPIRE TRAINING PWA - GOHIGHLEVEL INTEGRATION
        // ============================================
        
        /*
        üöÄ SETUP GUIDE FOR GOHIGHLEVEL INTEGRATION:
        
        1. GoHighLevel Account Setup:
           - Create a GoHighLevel account and location
           - Go to Settings ‚Üí Integrations ‚Üí API Keys
           - Create a new API key with contacts.readonly and contacts.write permissions
           - Note your Location ID from Settings ‚Üí Locations
        
        2. Contact Setup in GHL:
           - Create contacts with email addresses for your users
           - Add a custom field called 'password' to store app passwords
           - Add tags for subscription management: 'trial_active', 'paid_subscriber', 'legacy_39', 'standard_59', 'cancelled'
        
        3. Configuration:
           - Update GHL_CONFIG below with your Location ID and API Key
           - Production mode: All access requires valid GHL-generated license keys
        
        4. Subscription Management:
           - Users activate with GHL-generated license keys
           - License validation enforces device limits and expiration
           - Anti-tamper protection prevents unauthorized access
           - Real-time validation with device fingerprinting
        
        5. Security:
           - Passwords should be hashed in production
           - Use HTTPS for all API calls
           - Consider OAuth flow for enhanced security
           - Webhook signature verification in backend
        */
        
        // ============================================
        // GOHIGHLEVEL API INTEGRATION
        // ============================================
        
        // ‚ö†Ô∏è CONFIGURATION REQUIRED - Replace these values with your GoHighLevel credentials
        // Get these from your GoHighLevel account:
        // 1. Location ID: Settings ‚Üí Locations ‚Üí Location Details
        // 2. API Key: Settings ‚Üí Integrations ‚Üí API Keys ‚Üí Create New Key
        // 3. Update the webhook URLs in GHL to point to your server
        
        // GHL Configuration
        const GHL_CONFIG = {
            apiUrl: 'https://services.leadconnectorhq.com/v1',
            locationId: 'your_ghl_location_id_here', // üîß REPLACE WITH YOUR LOCATION ID
            apiKey: 'your_ghl_api_key_here', // üîß REPLACE WITH YOUR API KEY
            authUrl: 'https://marketplace.gohighlevel.com/oauth/chooselocation?response_type=code&redirect_uri=https://your-domain.com/auth&client_id=your_client_id&scope=contacts.readonly contacts.write'
        };

        // Subscription Configuration
        const SUBSCRIPTION_CONFIG = {
            trialDays: 14,
            gracePeriodDays: 7,
            tiers: {
                legacy: { price: 39.99, limit: 5000, tag: 'legacy_39' },
                standard: { price: 59.99, tag: 'standard_59' }
            },
            tags: {
                trial: 'trial_active',
                paid: 'paid_subscriber',
                legacy: 'legacy_39',
                standard: 'standard_59',
                cancelled: 'cancelled'
            }
        };

        // User Session Management
        let currentUser = null;
        let userSubscription = null;
        let lastSyncTime = null;
        let offlineMode = false;

        // ============================================
        // GHL API FUNCTIONS
        // ============================================

        class GHLApi {
            constructor() {
                this.baseUrl = GHL_CONFIG.apiUrl;
                this.locationId = GHL_CONFIG.locationId;
                this.apiKey = GHL_CONFIG.apiKey;
                
                // Validate configuration
                if (!this.locationId || this.locationId === 'your_ghl_location_id_here') {
                    console.error('‚ùå GoHighLevel Location ID not configured');
                    this.configured = false;
                } else if (!this.apiKey || this.apiKey === 'your_ghl_api_key_here') {
                    console.error('‚ùå GoHighLevel API Key not configured');
                    this.configured = false;
                } else {
                    console.log('‚úÖ GoHighLevel API configured');
                    this.configured = true;
                }
            }

            async makeRequest(endpoint, method = 'GET', data = null) {
                if (!this.configured) {
                    throw new Error('GoHighLevel API not configured. Please update GHL_CONFIG with your credentials.');
                }
                
                try {
                    const options = {
                        method,
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json',
                            'Version': '2021-07-28'
                        }
                    };

                    if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                        options.body = JSON.stringify(data);
                    }

                    const response = await fetch(`${this.baseUrl}${endpoint}`, options);
                    
                    if (!response.ok) {
                        throw new Error(`GHL API Error: ${response.status} ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('GHL API Request Failed:', error);
                    throw error;
                }
            }

            async findContactByEmail(email) {
                try {
                    const response = await this.makeRequest(
                        `/contacts/search?locationId=${this.locationId}&query=${encodeURIComponent(email)}`
                    );
                    
                    const contacts = response.contacts || [];
                    return contacts.find(contact => 
                        contact.email && contact.email.toLowerCase() === email.toLowerCase()
                    );
                } catch (error) {
                    console.error('Error finding contact:', error);
                    return null;
                }
            }

            async authenticateUser(email, password) {
                try {
                    // Find contact by email
                    const contact = await this.findContactByEmail(email);
                    
                    if (!contact) {
                        throw new Error('Email not found in our system');
                    }

                    // Check if contact has password field (custom field in GHL)
                    const storedPassword = contact.customFields?.find(
                        field => field.name === 'password' || field.id === 'password'
                    )?.value;

                    if (!storedPassword) {
                        throw new Error('Account not set up for app access');
                    }

                    // Simple password comparison (in production, use proper hashing)
                    if (storedPassword !== password) {
                        throw new Error('Invalid password');
                    }

                    return contact;
                } catch (error) {
                    console.error('Authentication failed:', error);
                    throw error;
                }
            }

            async getContactTags(contactId) {
                try {
                    const response = await this.makeRequest(`/contacts/${contactId}`);
                    return response.contact?.tags || [];
                } catch (error) {
                    console.error('Error getting contact tags:', error);
                    return [];
                }
            }

            async addTagToContact(contactId, tag) {
                try {
                    return await this.makeRequest(`/contacts/${contactId}/tags`, 'POST', {
                        tags: [tag]
                    });
                } catch (error) {
                    console.error('Error adding tag:', error);
                    throw error;
                }
            }

            async removeTagFromContact(contactId, tag) {
                try {
                    return await this.makeRequest(`/contacts/${contactId}/tags/${tag}`, 'DELETE');
                } catch (error) {
                    console.error('Error removing tag:', error);
                    throw error;
                }
            }

            async updateContactActivity(contactId, activity) {
                try {
                    const note = {
                        body: `NSPIRE App Activity: ${activity}`,
                        userId: contactId
                    };
                    
                    return await this.makeRequest(`/contacts/${contactId}/notes`, 'POST', note);
                } catch (error) {
                    console.error('Error updating activity:', error);
                }
            }
        }

        // Initialize GHL API
        const ghlApi = new GHLApi();

        // ============================================
        // SUBSCRIPTION MANAGEMENT
        // ============================================

        class SubscriptionManager {
            constructor() {
                this.storageKey = 'nspire_subscription_cache';
            }

            async checkSubscriptionStatus(contact) {
                try {
                    const tags = await ghlApi.getContactTags(contact.id);
                    const subscription = this.parseSubscriptionFromTags(tags, contact);
                    
                    // Cache subscription data
                    this.cacheSubscription(subscription);
                    
                    return subscription;
                } catch (error) {
                    console.error('Error checking subscription:', error);
                    // Return cached data if API fails
                    return this.getCachedSubscription();
                }
            }

            parseSubscriptionFromTags(tags, contact) {
                const tagNames = tags.map(tag => tag.name || tag);
                
                const subscription = {
                    contactId: contact.id,
                    email: contact.email,
                    status: 'inactive',
                    tier: null,
                    expiresAt: null,
                    inGracePeriod: false,
                    tags: tagNames,
                    lastChecked: new Date().toISOString()
                };

                // Check subscription status
                if (tagNames.includes(SUBSCRIPTION_CONFIG.tags.paid)) {
                    subscription.status = 'active';
                    
                    // Determine tier
                    if (tagNames.includes(SUBSCRIPTION_CONFIG.tags.legacy)) {
                        subscription.tier = 'legacy';
                    } else if (tagNames.includes(SUBSCRIPTION_CONFIG.tags.standard)) {
                        subscription.tier = 'standard';
                    }
                } else if (tagNames.includes(SUBSCRIPTION_CONFIG.tags.trial)) {
                    subscription.status = 'trial';
                    // Calculate trial expiration (14 days from creation)
                    const createdDate = new Date(contact.dateAdded || contact.createdAt);
                    const trialEnd = new Date(createdDate.getTime() + (SUBSCRIPTION_CONFIG.trialDays * 24 * 60 * 60 * 1000));
                    subscription.expiresAt = trialEnd.toISOString();
                    
                    // Check if trial expired
                    if (new Date() > trialEnd) {
                        subscription.status = 'expired';
                        this.checkGracePeriod(subscription, contact);
                    }
                } else if (tagNames.includes(SUBSCRIPTION_CONFIG.tags.cancelled)) {
                    subscription.status = 'cancelled';
                    this.checkGracePeriod(subscription, contact);
                }

                return subscription;
            }

            checkGracePeriod(subscription, contact) {
                // Check if within 7-day grace period
                const lastPaymentDate = new Date(contact.lastActivityAt || contact.dateAdded);
                const gracePeriodEnd = new Date(lastPaymentDate.getTime() + (SUBSCRIPTION_CONFIG.gracePeriodDays * 24 * 60 * 60 * 1000));
                
                if (new Date() <= gracePeriodEnd) {
                    subscription.inGracePeriod = true;
                    subscription.gracePeriodEnds = gracePeriodEnd.toISOString();
                }
            }

            cacheSubscription(subscription) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(subscription));
                    lastSyncTime = new Date().toISOString();
                } catch (error) {
                    console.error('Error caching subscription:', error);
                }
            }

            getCachedSubscription() {
                try {
                    const cached = localStorage.getItem(this.storageKey);
                    return cached ? JSON.parse(cached) : null;
                } catch (error) {
                    console.error('Error reading cached subscription:', error);
                    return null;
                }
            }

            clearCache() {
                localStorage.removeItem(this.storageKey);
                lastSyncTime = null;
            }

            isAccessAllowed(subscription) {
                if (!subscription) return false;

                switch (subscription.status) {
                    case 'active':
                        return true;
                    case 'trial':
                        return new Date() <= new Date(subscription.expiresAt);
                    case 'expired':
                    case 'cancelled':
                        return subscription.inGracePeriod;
                    default:
                        return false;
                }
            }

            getAccessMessage(subscription) {
                if (!subscription) {
                    return 'Please log in to access the NSPIRE Training App';
                }

                switch (subscription.status) {
                    case 'active':
                        return `Welcome back! Your ${subscription.tier} subscription is active.`;
                    case 'trial':
                        const daysLeft = Math.ceil((new Date(subscription.expiresAt) - new Date()) / (1000 * 60 * 60 * 24));
                        return `Trial active - ${daysLeft} days remaining`;
                    case 'expired':
                        if (subscription.inGracePeriod) {
                            const graceLeft = Math.ceil((new Date(subscription.gracePeriodEnds) - new Date()) / (1000 * 60 * 60 * 24));
                            return `Subscription expired - ${graceLeft} grace period days remaining`;
                        }
                        return 'Subscription expired. Please renew to continue access.';
                    case 'cancelled':
                        if (subscription.inGracePeriod) {
                            return 'Subscription cancelled - limited access during grace period';
                        }
                        return 'Subscription cancelled. Please reactivate to continue access.';
                    default:
                        return 'No active subscription found';
                }
            }
        }

        // Initialize Subscription Manager
        const subscriptionManager = new SubscriptionManager();

        // ============================================
        // ENHANCED LOGIN SYSTEM
        // ============================================

        async function handleGHLLogin(event) {
            if (event) {
                event.preventDefault();
            }

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginButton = document.querySelector('.btn');
            const errorDiv = document.getElementById('login-error');

            // Clear previous errors
            if (errorDiv) errorDiv.remove();

            // Validation
            if (!email || !password) {
                showLoginError('Please enter both email and password');
                return;
            }

            // Check if GHL is configured
            if (!ghlApi.configured) {
                showLoginError('System configuration required. Please contact support.');
                return;
            }

            // Show loading state
            loginButton.textContent = 'Authenticating...';
            loginButton.disabled = true;

            try {
                // Authenticate with GHL
                const contact = await ghlApi.authenticateUser(email, password);
                
                if (!contact) {
                    throw new Error('Authentication failed');
                }

                // Check subscription status
                const subscription = await subscriptionManager.checkSubscriptionStatus(contact);
                
                // Store user session
                currentUser = contact;
                userSubscription = subscription;
                
                // Update activity log
                await ghlApi.updateContactActivity(contact.id, 'App Login');

                // Check access permissions
                if (subscriptionManager.isAccessAllowed(subscription)) {
                    // Success - show app
                    showAppContent(subscription);
                } else {
                    // No access - show subscription message
                    showSubscriptionRequired(subscription);
                }

            } catch (error) {
                console.error('Login failed:', error);
                showLoginError(error.message || 'Login failed. Please try again.');
            } finally {
                // Reset button
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
            }
        }

        function showLoginError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.id = 'login-error';
            errorDiv.style.cssText = `
                background: #fee2e2;
                border: 1px solid #fca5a5;
                color: #dc2626;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 16px;
                font-size: 14px;
                text-align: center;
            `;
            errorDiv.textContent = message;
            
            const loginForm = document.querySelector('.login-form');
            loginForm.insertBefore(errorDiv, loginForm.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function showAppContent(subscription) {
            // Show logout button
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.style.display = 'block';
            }
            
            // Show subscription status
            showSubscriptionStatus(subscription);
            
            // Navigate to search page - DISABLED for license system
            // showSearchPage();
            
            // Track app usage
            trackAppUsage('app_accessed');
        }

        function showSubscriptionRequired(subscription) {
            const message = subscriptionManager.getAccessMessage(subscription);
            
            const subscriptionDiv = document.createElement('div');
            subscriptionDiv.innerHTML = `
                <div style="text-align: center; padding: 24px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; margin: 16px 0;">
                    <h3 style="color: #92400e; margin-bottom: 12px;">Subscription Required</h3>
                    <p style="color: #78350f; margin-bottom: 16px;">${message}</p>
                    <button onclick="showSubscriptionOptions()" class="btn" style="width: auto; padding: 8px 16px;">
                        View Subscription Options
                    </button>
                </div>
            `;
            
            const loginForm = document.querySelector('.login-form');
            loginForm.appendChild(subscriptionDiv);
        }

        function showSubscriptionStatus(subscription) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'subscription-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: #10b981;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                z-index: 1000;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            const message = subscriptionManager.getAccessMessage(subscription);
            statusDiv.textContent = message;
            
            // Color based on status
            switch (subscription.status) {
                case 'active':
                    statusDiv.style.background = '#10b981'; // green
                    break;
                case 'trial':
                    statusDiv.style.background = '#f59e0b'; // yellow
                    break;
                case 'expired':
                case 'cancelled':
                    statusDiv.style.background = subscription.inGracePeriod ? '#f59e0b' : '#ef4444'; // yellow or red
                    break;
            }
            
            document.body.appendChild(statusDiv);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (statusDiv.parentElement) {
                    statusDiv.remove();
                }
            }, 10000);
        }

        function showSubscriptionOptions() {
            alert(`NSPIRE Training App Subscription Options:

Legacy Plan: $39.99/year (Limited to first 5,000 users)
Standard Plan: $59.99/year

14-day trial available for $1

Contact support for subscription assistance.`);
        }

        // ============================================
        // OFFLINE SUPPORT & SYNC
        // ============================================

        function initializeOfflineSupport() {
            // Check if online
            function updateOnlineStatus() {
                offlineMode = !navigator.onLine;
                
                if (offlineMode) {
                    showOfflineIndicator();
                } else {
                    hideOfflineIndicator();
                    // Sync when back online
                    syncWhenOnline();
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Initial check
            updateOnlineStatus();
        }

        function showOfflineIndicator() {
            let indicator = document.getElementById('offline-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'offline-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #ef4444;
                    color: white;
                    text-align: center;
                    padding: 8px;
                    font-size: 14px;
                    z-index: 9999;
                `;
                indicator.textContent = 'Offline Mode - Using cached data';
                document.body.insertBefore(indicator, document.body.firstChild);
            }
        }

        function hideOfflineIndicator() {
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function syncWhenOnline() {
            if (!currentUser || offlineMode) return;

            try {
                // Re-verify subscription status
                const subscription = await subscriptionManager.checkSubscriptionStatus(currentUser);
                userSubscription = subscription;
                
                // Check if access still allowed
                if (!subscriptionManager.isAccessAllowed(subscription)) {
                    // Access revoked - show warning and logout
                    alert('Your subscription status has changed. Please log in again.');
                    handleLogout();
                }
                
                console.log('‚úì Subscription status synced');
            } catch (error) {
                console.error('Sync failed:', error);
            }
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================

        function initializeSession() {
            // Show configuration status
            if (!ghlApi.configured) {
                showConfigurationWarning();
            }
            
            // Check for existing session
            const savedUser = localStorage.getItem('nspire_current_user');
            const savedSubscription = subscriptionManager.getCachedSubscription();
            
            if (savedUser && savedSubscription) {
                currentUser = JSON.parse(savedUser);
                userSubscription = savedSubscription;
                
                // Check if session is still valid (within grace period)
                const lastCheck = new Date(savedSubscription.lastChecked);
                const now = new Date();
                const hoursSinceCheck = (now - lastCheck) / (1000 * 60 * 60);
                
                if (hoursSinceCheck < 24 && subscriptionManager.isAccessAllowed(savedSubscription)) {
                    // Session valid - show app
                    showAppContent(savedSubscription);
                    return;
                }
            }
            
            // No valid session - show login
            showPage('loginPage');
        }

        function showConfigurationWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'config-warning';
            warningDiv.style.cssText = `
                background: #fef3c7;
                border: 1px solid #f59e0b;
                color: #92400e;
                padding: 12px;
                border-radius: 8px;
                margin: 16px;
                font-size: 14px;
                text-align: center;
            `;
            // Configuration text removed - using license system now
            
            const loginPage = document.getElementById('loginPage');
            // loginPage.insertBefore(warningDiv, loginPage.firstChild); // Removed
        }

        function saveUserSession() {
            if (currentUser) {
                localStorage.setItem('nspire_current_user', JSON.stringify(currentUser));
            }
        }

        function handleLogout() {
            // Clear session data
            currentUser = null;
            userSubscription = null;
            localStorage.removeItem('nspire_current_user');
            subscriptionManager.clearCache();
            
            // Hide logout button
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.style.display = 'none';
            }
            
            // Clear status indicators
            const statusDiv = document.getElementById('subscription-status');
            if (statusDiv) statusDiv.remove();
            
            // Return to login
            showPage('loginPage');
        }

        // ============================================
        // USAGE TRACKING
        // ============================================

        async function trackAppUsage(action, details = '') {
            if (!currentUser || offlineMode) return;

            try {
                const activity = `${action}${details ? ': ' + details : ''}`;
                await ghlApi.updateContactActivity(currentUser.id, activity);
            } catch (error) {
                console.error('Failed to track usage:', error);
            }
        }

        // Track page views
        function trackPageView(pageName) {
            trackAppUsage('page_view', pageName);
        }

        // ============================================
        // EXISTING APP INTEGRATION
        // ============================================

        // Global function declarations

        // ============================================
    // DYNAMICALLY LOAD JSON DATA FROM nspire_standards.json
        // ============================================
        let nspireData = [];
        let imageAssignments = new Map();

        function loadImageAssignments() {
            try {
                console.log('üîÑ Starting to load image assignments...');
                // First try to load from the image-assignments.json file with cache busting
                const cacheBuster = '?v=' + Date.now();
                fetch('image-assignments.json' + cacheBuster, { cache: 'no-store' })
                    .then(response => {
                        console.log('üì° Fetch response status:', response.status, response.statusText);
                        console.log('üì° Response OK:', response.ok);
                        console.log('üì° Response URL:', response.url);
                        
                        if (response.ok) {
                            console.log('‚úì Response OK, parsing JSON...');
                            return response.json();
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    })
                    .then(assignments => {
                        console.log('‚úì Successfully parsed JSON, assignments count:', Object.keys(assignments).length);
                        console.log('‚úì Loaded assignments from image-assignments.json');
                        processAssignments(assignments);
                    })
                    .catch(error => {
                        console.error('‚ùå Error loading image-assignments.json:', error);
                        console.log('üîÑ Falling back to localStorage...');
                        
                        // Fallback to localStorage
                        const savedAssignments = localStorage.getItem('nspireImageAssignmentsV1');
                        if (savedAssignments) {
                            console.log('‚úì Found saved assignments in localStorage');
                            const assignments = JSON.parse(savedAssignments);
                            processAssignments(assignments);
                        } else {
                            console.log('‚ùå No image assignments found in localStorage');
                            imageAssignments = new Map();
                            showNoDataMessage();
                        }
                    });
            } catch (error) {
                console.error('Error loading image assignments:', error);
                imageAssignments = new Map();
                showNoDataMessage();
            }
        }

        function processAssignments(assignments) {
            imageAssignments = new Map();
            let processed = 0;
            
            for (const [key, value] of Object.entries(assignments)) {
                if (value && value.src) {
                    imageAssignments.set(key, {
                        outputPath: value.src, // Use the base64 data URL directly
                        description: value.filename || key,
                        filename: value.filename || 'image.webp'
                    });
                    processed++;
                }
            }
            
            console.log(`‚úì Processed ${processed} image assignments`);
            
            // Debug message disabled to prevent notifications
            // Green banner with "Images Loaded" message removed
        }

        function showNoDataMessage() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debug-info';
            debugDiv.style.cssText = 'position:fixed; top:10px; right:10px; background:red; color:white; border:1px solid #ccc; padding:10px; z-index:9999; max-width:300px; font-size:12px;';
            debugDiv.innerHTML = `
                <strong>‚ùå No Image Data</strong><br>
                No assignments found in file or localStorage<br>
                Check browser console for detailed error info<br>
                <button onclick="this.parentElement.remove()" style="color:white; background:transparent; border:1px solid white;">√ó</button>
            `;
            document.body.appendChild(debugDiv);
            console.error('‚ùå No image data available - check network tab and console for fetch errors');
        }

        // Data loading moved to loadAppData() - only load after license validation
        // Original immediate loading commented out to prevent loading before license check
        /*
        fetch('nspire_standards.json?v=' + Date.now(), { cache: 'no-store' })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load nspire_standards.json');
                }
                return response.json();
            })
            .then(data => {
                nspireData = data;
                loadImageAssignments(); // Load image assignments after standards
                console.log('‚úì Successfully loaded', data.length, 'standards');
                
                // Automatically go to search page if data loaded successfully - DISABLED for license system
                // showSearchPage();
                
                // Once standards are loaded, we can render weights-dependent views if weights are ready
                if (window.__weightsLoaded) {
                    // no-op, rendering happens upon navigating to details
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                const list = document.getElementById('standardsList');
                if (list) {
                    list.innerHTML = '<div class="error-message">Error loading nspire_standards.json. Please ensure the file exists and is valid JSON.</div>';
                }
            });
        */

        let currentStandard = null;
        // Removed scoring/weights external fetches to keep this PWA self-contained and avoid 404s
        let hudSamplingTable = null;
        let weightsData = null;
        let severityLocationWeights = null;

        // Load weights and sampling table
        async function loadWeightsAndSampling() {
            try {
                console.log('üîÑ Loading weights and sampling data...');
                
                // Load sampling table
                const samplingResponse = await fetch('src/score/hud_sampling_table.json');
                if (samplingResponse.ok) {
                    hudSamplingTable = await samplingResponse.json();
                    console.log('‚úì Loaded HUD sampling table:', hudSamplingTable.length, 'entries');
                } else {
                    console.error('‚ùå Failed to load sampling table:', samplingResponse.status);
                }

                // Load severity location weights (the correct chart!)
                const severityLocationResponse = await fetch('src/score/severity_location_weights.json');
                if (severityLocationResponse.ok) {
                    severityLocationWeights = await severityLocationResponse.json();
                    console.log('‚úì Loaded severity location weights:', severityLocationWeights);
                    window.__weightsLoaded = true;
                    
                    // Debug message disabled to prevent notifications
                    console.log('‚úì Calculator Ready - Severity location weights loaded');
                } else {
                    console.error('‚ùå Failed to load severity location weights:', severityLocationResponse.status);
                }
            } catch (error) {
                console.error('‚ùå Error loading weights and sampling data:', error);
            }
        }

        function initializeApp() {
            if (nspireData && nspireData.length > 0) {
                console.log(`‚úì App ready with ${nspireData.length} standards`);
                displayStandards();
            } else {
                const list = document.getElementById('standardsList');
                if (list) {
                    list.innerHTML = '<div class="error-message">No data loaded. Please check nspire_standards.json.</div>';
                }
                console.error('‚úó No data found. Please check nspire_standards.json.');
                list.innerHTML = '<div class="error-message">Error loading nspire_standards.json. Please ensure the file exists and is valid JSON.</div>';
            }
        }

        // Parse severity into area-based badges
        function parseSeverityByArea(severityText) {
            if (!severityText) return [];
            
            const severities = [];
            const lines = severityText.split('\n').filter(line => line.trim());
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                console.log('Processing line:', line);
                
                // Check for HCV in next line
                const nextLine = i < lines.length - 1 ? lines[i + 1] : '';
                let hcv = null;
                
                if (nextLine.includes('HCV:FAIL') || nextLine.includes('HCV: FAIL')) {
                    hcv = 'fail';
                    i++; // Skip the HCV line since we've processed it
                } else if (nextLine.includes('HCV:PASS') || nextLine.includes('HCV: PASS')) {
                    hcv = 'pass';
                    i++; // Skip the HCV line since we've processed it
                }
                
                // Check for severity level
                let severity = null;
                if (line.includes('LIFE THREATENING')) {
                    severity = 'life-threatening';
                } else if (line.includes('SEVERE')) {
                    severity = 'severe';
                } else if (line.includes('MODERATE')) {
                    severity = 'moderate';
                } else if (line.includes('LOW')) {
                    severity = 'low';
                }
                
                // Check for area
                const areaMatch = line.match(/\((UNIT|INSIDE|OUTSIDE)[^)]*\)/);
                if (severity && areaMatch) {
                    severities.push({
                        level: severity,
                        area: areaMatch[0],
                        hcv: hcv,
                        text: line
                    });
                }
            }
            
            console.log('Final severities:', severities);
            return severities;
        }

        function getTimeframe(severityText) {
            if (!severityText) return null;
            const match = severityText.match(/(\d+)\s*(HOUR|DAY)/i);
            if (match) {
                return `Correction Timeframe: ${match[1]} ${match[2].toLowerCase()}s`;
            }
            return null;
        }

        function showPage(pageId) {
            console.log('Showing page:', pageId);
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                console.error('Could not find page:', pageId);
            }
        }

        // ============================================================================
        // NSPIRE TRAINING PRO - LICENSE VALIDATION SYSTEM
        // ============================================================================
        
        // Security Configuration
        const SECURITY_CONFIG = {
            MAX_DEVICES: 2,
            ENTERPRISE_MAX_DEVICES: 10,
            LICENSE_VALIDITY_DAYS: 365,
            OFFLINE_GRACE_DAYS: 30,
            REVALIDATION_INTERVAL_DAYS: 7,
            ANTI_TAMPER_ENABLED: true // Keep security active
        };
        
        // Device Fingerprinting
        class DeviceFingerprinting {
            static generateFingerprint() {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || 'unknown',
                    navigator.platform,
                    navigator.cookieEnabled.toString()
                ];
                
                const fingerprint = components.join('|');
                return this.hashString(fingerprint).substring(0, 16);
            }
            
            static hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash).toString(36);
            }
        }
        
        // Anti-Developer Tools Detection
        class AntiTamper {
            static isEnabled = SECURITY_CONFIG.ANTI_TAMPER_ENABLED;
            static detectionActive = false;
            
            static startProtection() {
                if (!this.isEnabled) return;
                
                this.detectionActive = true;
                this.detectDevTools();
                this.detectDebugger();
                this.detectInspection();
                
                console.log('%cNSPIRE Training Pro', 'color: #FF6B35; font-size: 24px; font-weight: bold;');
                console.log('%cUnauthorized access detected. Application will be disabled.', 'color: #dc3545; font-size: 14px;');
            }
            
            static detectDevTools() {
                let devtools = false;
                const threshold = 200; // Increased threshold to reduce false positives
                let consecutiveDetections = 0;
                
                setInterval(() => {
                    if (!this.detectionActive) return;
                    
                    // More reliable detection - check both dimensions and require consistency
                    const heightDiff = window.outerHeight - window.innerHeight;
                    const widthDiff = window.outerWidth - window.innerWidth;
                    
                    if (heightDiff > threshold || widthDiff > threshold) {
                        consecutiveDetections++;
                        // Require 3 consecutive detections to avoid false positives
                        if (consecutiveDetections >= 3) {
                            this.triggerSecurity('Developer tools detected');
                        }
                    } else {
                        consecutiveDetections = 0; // Reset counter
                    }
                }, 2000); // Check every 2 seconds instead of 1
            }
            
            static detectDebugger() {
                setInterval(() => {
                    if (!this.detectionActive) return;
                    
                    // More sophisticated debugger detection
                    const start = performance.now();
                    try {
                        debugger;
                    } catch (e) {
                        // Ignore errors
                    }
                    const end = performance.now();
                    
                    // Increased threshold and added try-catch for stability
                    if (end - start > 200) { // Increased from 100 to 200ms
                        this.triggerSecurity('Debugger detected');
                    }
                }, 3000); // Check every 3 seconds instead of 2
            }
            
            static detectInspection() {
                let elementCount = 0;
                let stabilityCounter = 0;
                
                setInterval(() => {
                    if (!this.detectionActive) return;
                    
                    const currentCount = document.querySelectorAll('*').length;
                    
                    // Only trigger if DOM changes are significant and repeated
                    if (elementCount > 0) {
                        const change = Math.abs(currentCount - elementCount);
                        if (change > 100) { // Increased threshold from 50 to 100
                            stabilityCounter++;
                            if (stabilityCounter >= 2) { // Require 2 consecutive large changes
                                this.triggerSecurity('DOM manipulation detected');
                            }
                        } else {
                            stabilityCounter = 0; // Reset if change is small
                        }
                    }
                    elementCount = currentCount;
                }, 5000); // Check every 5 seconds instead of 3
            }
            
            static triggerSecurity(reason) {
                this.detectionActive = false;
                document.body.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; padding: 20px;">
                        <h1 style="color: #dc3545; margin-bottom: 20px;">üö´ Access Denied</h1>
                        <p style="font-size: 18px; margin-bottom: 10px;">Security violation detected: ${reason}</p>
                        <p style="color: #666;">Please use the app normally without developer tools.</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #FF6B35; color: white; border: none; border-radius: 5px; cursor: pointer;">Reload App</button>
                    </div>
                `;
            }
        }
        
        // License Management System
        class LicenseManager {
            static validateLicenseFormat(licenseKey) {
                // GHL Format: NSPIRE-2025-XXXXXX-XXXXXX-XXXXXX (6 characters per segment)
                const ghlPattern = /^NSPIRE-2025-[A-Z0-9]{6}-[A-Z0-9]{6}-[A-Z0-9]{6}$/;
                const upperKey = licenseKey.toUpperCase();
                return ghlPattern.test(upperKey);
            }
            
            static parseLicenseKey(licenseKey) {
                const parts = licenseKey.toUpperCase().split('-');
                if (parts.length !== 5) return null;
                
                // GHL Format validation: NSPIRE-2025-SEGMENT1-SEGMENT2-SEGMENT3
                if (parts[0] !== 'NSPIRE' || parts[1] !== '2025') return null;
                if (parts[2].length !== 6 || parts[3].length !== 6 || parts[4].length !== 6) return null;
                
                return {
                    prefix: parts[0],
                    year: parts[1], 
                    segment1: parts[2],
                    segment2: parts[3],
                    segment3: parts[4],
                    full: licenseKey.toUpperCase(),
                    format: 'ghl'
                };
            }
            
            static generateLicenseHash(licenseKey, deviceFingerprint) {
                // Create a hash that combines license key with device fingerprint
                const combined = licenseKey + '|' + deviceFingerprint;
                return DeviceFingerprinting.hashString(combined);
            }
            
            static async activateLicense(licenseKey) {
                // Validate format
                if (!this.validateLicenseFormat(licenseKey)) {
                    throw new Error('Invalid license key format');
                }
                
                const deviceFingerprint = DeviceFingerprinting.generateFingerprint();
                const parsedLicense = this.parseLicenseKey(licenseKey);
                
                // Check if license is already stored locally
                const existingLicense = this.getStoredLicense();
                if (existingLicense && existingLicense.key === parsedLicense.full) {
                    if (this.isLicenseValid(existingLicense)) {
                        return existingLicense;
                    }
                }
                
                // Simulate license validation (in production, this would call your server)
                const licenseData = await this.validateWithServer(parsedLicense.full, deviceFingerprint);
                
                // Store license locally
                const licenseInfo = {
                    key: parsedLicense.full,
                    activatedAt: new Date().toISOString(),
                    expiresAt: licenseData.expiresAt,
                    plan: licenseData.plan,
                    deviceFingerprint: deviceFingerprint,
                    deviceCount: licenseData.deviceCount,
                    maxDevices: licenseData.maxDevices,
                    lastValidated: new Date().toISOString()
                };
                
                localStorage.setItem('nspire_license', JSON.stringify(licenseInfo));
                localStorage.setItem('nspire_device_id', deviceFingerprint);
                
                return licenseInfo;
            }
            
            static async validateWithServer(licenseKey, deviceFingerprint) {
                // Validate license format first
                if (!this.validateLicenseFormat(licenseKey)) {
                    throw new Error('Invalid license key format. Must be NSPIRE-2025-XXXXXX-XXXXXX-XXXXXX');
                }
                
                // Parse the license key
                const parsedKey = this.parseLicenseKey(licenseKey);
                
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate network delay
                
                // GHL License Type Detection:
                // Trial: segment1 contains "DEMO" (14 days, 1 device)
                // Annual: All others including Single/Regional/Enterprise (365 days, 2 devices)
                if (parsedKey.segment1.includes('DEMO')) {
                    return {
                        expiresAt: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(), // 14 days
                        plan: 'trial',
                        deviceCount: 1,
                        maxDevices: 1
                    };
                }
                
                // All other valid GHL keys (Single/Regional/Enterprise) are annual licenses
                return {
                    expiresAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(), // 1 year
                    plan: 'annual',
                    deviceCount: 1,
                    maxDevices: 2 // 2 devices for annual license (Single gets 1 key, Regional gets 5, Enterprise gets 10)
                };
            }
            
            static getStoredLicense() {
                try {
                    const stored = localStorage.getItem('nspire_license');
                    if (!stored) return null;
                    
                    const license = JSON.parse(stored);
                    
                    // Validate stored license integrity
                    if (!license.key || !license.deviceFingerprint || !license.activatedAt) {
                        console.warn('Invalid license structure detected');
                        localStorage.removeItem('nspire_license');
                        return null;
                    }
                    
                    // Re-validate format to prevent tampering
                    if (!this.validateLicenseFormat(license.key)) {
                        console.warn('License format validation failed');
                        localStorage.removeItem('nspire_license');
                        return null;
                    }
                    
                    // Allow device fingerprint flexibility for browser updates
                    // Only clear license for major device changes, not minor browser updates
                    const currentDevice = DeviceFingerprinting.generateFingerprint();
                    if (license.deviceFingerprint !== currentDevice) {
                        console.warn('Device fingerprint mismatch - possible browser update');
                        // Don't clear license for fingerprint changes - allow flexibility
                    }
                    
                    return license;
                } catch (error) {
                    console.error('Error reading stored license:', error);
                    localStorage.removeItem('nspire_license');
                    return null;
                }
            }
            
            static isLicenseValid(license) {
                if (!license) return false;
                
                // Check if expired
                if (new Date(license.expiresAt) < new Date()) {
                    return false;
                }
                
                // Check device fingerprint
                const currentFingerprint = DeviceFingerprinting.generateFingerprint();
                if (license.deviceFingerprint !== currentFingerprint) {
                    // Allow some flexibility for browser updates, but not completely different devices
                    console.warn('Device fingerprint mismatch - possible device change');
                }
                
                return true;
            }
            
            static getRemainingDays(license) {
                if (!license) return 0;
                const now = new Date();
                const expiry = new Date(license.expiresAt);
                const diffTime = expiry - now;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            
            static clearLicense() {
                localStorage.removeItem('nspire_license');
                localStorage.removeItem('nspire_device_id');
            }
        }
        
        // QR Code Scanner
        class QRScanner {
            static stream = null;
            static scanning = false;
            
            static async startScanner() {
                try {
                    const video = document.getElementById('qrVideo');
                    const canvas = document.getElementById('qrCanvas');
                    
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    
                    video.srcObject = this.stream;
                    video.play();
                    
                    this.scanning = true;
                    this.scanFrame(video, canvas);
                    
                    return true;
                } catch (error) {
                    console.error('Camera access denied:', error);
                    showLicenseMessage('Camera access required for QR scanning', 'error');
                    return false;
                }
            }
            
            static stopScanner() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                this.scanning = false;
                
                const video = document.getElementById('qrVideo');
                if (video) {
                    video.srcObject = null;
                }
            }
            
            static scanFrame(video, canvas) {
                if (!this.scanning) return;
                
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Simple QR detection (in production, use a proper QR library like jsQR)
                    const qrCode = this.detectQRCode(imageData);
                    if (qrCode && qrCode.startsWith('NSPIRE-')) {
                        this.stopScanner();
                        document.getElementById('licenseKeyInput').value = qrCode;
                        activateLicense();
                        return;
                    }
                }
                
                requestAnimationFrame(() => this.scanFrame(video, canvas));
            }
            
            static detectQRCode(imageData) {
                // Simplified QR detection - in production, use jsQR library
                // For demo purposes, we'll simulate QR detection
                return null;
            }
        }
        
        // UI Functions
        function showActivationMethod(method) {
            // Update tabs
            document.querySelectorAll('.method-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.activation-method').forEach(method => method.classList.remove('active'));
            document.getElementById(method + 'Method').classList.add('active');
        }
        
        function showLicenseMessage(message, type = 'info') {
            const messageDiv = document.getElementById('licenseMessage');
            messageDiv.textContent = message;
            messageDiv.className = `license-message ${type}`;
        }
        
        function clearLicenseMessage() {
            const messageDiv = document.getElementById('licenseMessage');
            messageDiv.className = 'license-message';
        }
        
        async function activateLicense() {
            const licenseKey = document.getElementById('licenseKeyInput').value.trim().toUpperCase();
            
            if (!licenseKey) {
                showLicenseMessage('Please enter a license key', 'error');
                return;
            }
            
            // Pre-validation: Strict GHL format check
            if (!LicenseManager.validateLicenseFormat(licenseKey)) {
                showLicenseMessage('‚ùå Invalid license key format. Must be NSPIRE-2025-XXXXXX-XXXXXX-XXXXXX', 'error');
                return;
            }
            
            try {
                showLicenseMessage('Validating license...', 'info');
                
                const licenseInfo = await LicenseManager.activateLicense(licenseKey);
                
                showLicenseMessage('License activated successfully! ‚úÖ', 'success');
                
                setTimeout(() => {
                    showMainApp(licenseInfo);
                }, 1500);
                
            } catch (error) {
                showLicenseMessage('‚ùå ' + error.message, 'error');
            }
        }
        
        function startQRScanner() {
            QRScanner.startScanner();
        }
        
        function stopQRScanner() {
            QRScanner.stopScanner();
        }
        
        function showPurchaseOptions() {
            alert('Purchase NSPIRE Training Pro:\\n\\nüè† Annual License: $59.99/year\\nüè¢ Enterprise License: $199.99/year\\n\\nVisit: https://nspiretraining.com/purchase');
        }
        
        function renewLicense() {
            // Redirect to GHL purchase page where users can buy activation key with QR code
            window.open('https://nspiretrainingapp.com', '_blank');
        }
        
        function showDemoMode() {
            // Limited demo mode
            const demoLicense = {
                key: 'DEMO-MODE',
                plan: 'demo',
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 hours
                deviceFingerprint: DeviceFingerprinting.generateFingerprint()
            };
            showMainApp(demoLicense);
        }
        
        // Production License Activation Only - No Test Functions
        function showMainApp(licenseInfo) {
            // Hide license page and show main app
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('searchPage').classList.add('active');
            
            // Start security protection
            AntiTamper.startProtection();
            
            // Display license status
            displayLicenseStatus(licenseInfo);
            
            // Load data after successful license validation
            console.log('üîÑ Loading app data after license validation...');
            loadAppData();
        }
        
        function loadAppData() {
            // Load data from standards file when license is validated
            fetch('nspire_standards.json?v=' + Date.now(), { cache: 'no-store' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load nspire_standards.json');
                    }
                    return response.json();
                })
                .then(data => {
                    nspireData = data;
                    console.log('‚úì Successfully loaded', data.length, 'standards');
                    
                    // Load image assignments after standards
                    loadImageAssignments();
                    
                    // Show the search page now that data is loaded
                    showSearchPage();
                })
                .catch(error => {
                    console.error('Error loading app data:', error);
                });
        }
        
        function displayLicenseStatus(licenseInfo) {
            const remainingDays = LicenseManager.getRemainingDays(licenseInfo);
            const expiryDate = new Date(licenseInfo.expiresAt);
            const formattedDate = expiryDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            let statusText = '';
            if (licenseInfo.plan === 'demo' || licenseInfo.plan === 'trial') {
                statusText = 'Trial';
            } else if (licenseInfo.plan === 'enterprise') {
                statusText = 'Enterprise';
            } else {
                statusText = 'Active';
            }
            
            const statusHtml = `
                <div class="license-status-compact">
                    Status: ${statusText} ‚Ä¢ Expires: ${formattedDate}
                </div>
            `;
            
            // Add status to header or appropriate location
            const header = document.querySelector('.header') || document.querySelector('#searchPage');
            if (header && !header.querySelector('.license-status-compact')) {
                header.insertAdjacentHTML('beforeend', statusHtml);
            }
        }
        
        // Initialize license system
        document.addEventListener('DOMContentLoaded', function() {
            
            // Check for existing valid license on startup
            const existingLicense = LicenseManager.getStoredLicense();
            if (existingLicense && LicenseManager.isLicenseValid(existingLicense)) {
                console.log('‚úì Found valid stored license, proceeding to main app');
                showMainApp(existingLicense);
            } else {
                console.log('‚ùå No valid stored license found, showing activation page');
                LicenseManager.clearLicense();
                // Force show license activation page
                document.getElementById('loginPage').classList.add('active');
                document.getElementById('searchPage').classList.remove('active');
            }
        });
        
        // Disable context menu and common shortcuts
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                (e.ctrlKey && e.key === 'u')) {
                e.preventDefault();
                AntiTamper.triggerSecurity('Keyboard shortcut detected');
            }
        });

        function showCreateAccount() {
            alert('Account creation will be handled through App Store.\nSubscription: $4.99/month or $45/year');
        }

        function showSearchPage() {
            showPage('searchPage');
            displayStandards();
            trackPageView('search');
        }

        function showDetailsPage(standardIndex) {
            currentStandard = nspireData[standardIndex];
            currentStandard.index = standardIndex;
            showPage('detailsPage');
            displayDeficiencyDetails();
            trackPageView(`details_${currentStandard.title || currentStandard.id}`);
        }

        function displayStandards() {
            const list = document.getElementById('standardsList');
            
            // Check if data exists
            if (!nspireData || nspireData.length === 0) {
                list.innerHTML = '<div class="error-message">No data loaded. Please add your JSON data to the nspireData variable above.</div>';
                console.error('nspireData is empty. Please paste your JSON data between the brackets.');
                return;
            }
            
            // Display all standards
            list.innerHTML = nspireData.map((standard, index) => `
                <div class="standard-item" onclick="showDetailsPage(${index})">
                    <div class="standard-title">${standard.title || standard.id}</div>
                </div>
            `).join('');
            
            console.log(`Displayed ${nspireData.length} standards`);
        }

        function filterStandards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('standardsList');
            
            if (!searchTerm) {
                displayStandards();
                return;
            }
            
            const filtered = nspireData.map((standard, index) => {
                const stdTitle = (standard.title || standard.id || '').toLowerCase();
                const matchesStandard = stdTitle.includes(searchTerm);
                const matchesDeficiency = Array.isArray(standard.deficiencies) && 
                    standard.deficiencies.some(def => {
                        const t = (def.title || '').toLowerCase();
                        const v = (def.verbatim || '').toLowerCase();
                        return t.includes(searchTerm) || v.includes(searchTerm);
                    });

                if (matchesStandard || matchesDeficiency) {
                    return `
                        <div class="standard-item" onclick="showDetailsPage(${index})">
                            <div class="standard-title">${standard.title || standard.id}</div>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            list.innerHTML = filtered || '<div class="error-message">No standards found</div>';
        }

        function displayDeficiencyDetails() {
            if (!currentStandard) return;
            const details = document.getElementById('deficiencyDetails');
            let deficienciesHtml = '';
                function toUpperKey(s) {
                    return (s || '').toString().trim().toUpperCase();
                }
                function getSampleSize(totalUnits) {
                    const n = Math.max(1, parseInt(totalUnits || '1', 10) || 1);
                    if (!Array.isArray(hudSamplingTable) || !hudSamplingTable.length) return 1;
                    for (const row of hudSamplingTable) {
                        const min = row.min ?? 1;
                        const max = row.max;
                        if (n >= min && (max == null || n <= max)) {
                            return row.sample || 1;
                        }
                    }
                    return 1;
                }
                // Scoring/weights calculation - CORRECTED to use severity_location_weights chart
                function calculatePointsLost(deficiency, standardId, totalUnits = 1) {
                    if (!severityLocationWeights) {
                        console.log('‚ö†Ô∏è No severity location weights data available for calculation');
                        return 0;
                    }

                    const severity = (deficiency.severity || 'LOW').toUpperCase();
                    const location = (deficiency.location || 'UNIT').toUpperCase();
                    
                    console.log(`üßÆ Calculating points for ${standardId}:`, {
                        severity, location, totalUnits
                    });
                    
                    // Get the pre-calculated chart value
                    const chartValue = severityLocationWeights[severity] && severityLocationWeights[severity][location];
                    
                    if (!chartValue) {
                        console.log('‚ö†Ô∏è No chart value found for', severity, location);
                        return 0;
                    }

                    // Get sample size for the total units
                    const sampleSize = getSampleSize(totalUnits);
                    
                    console.log('Chart lookup:', {
                        severity, location, chartValue, sampleSize
                    });
                    
                    // CORRECT CALCULATION: Only divide chart value by sample size
                    const points = chartValue / sampleSize;
                    
                    console.log(`Calculation: ${chartValue} √∑ ${sampleSize} = ${points}`);
                    
                    const finalPoints = Math.round(points * 100) / 100;
                    console.log('Final points:', finalPoints);
                    
                    return finalPoints; // Round to 2 decimal places
                }

                // New function to calculate points for specific location/severity combination
                function calculatePointsLostForGroup(severity, location, totalUnits = 1) {
                    if (!severityLocationWeights) {
                        console.log('‚ö†Ô∏è No severity location weights data available for calculation');
                        return 0;
                    }

                    const severityKey = severity.toUpperCase();
                    const locationKey = location.toUpperCase();
                    
                    console.log(`üßÆ Calculating points for group:`, {
                        severity: severityKey, location: locationKey, totalUnits
                    });
                    
                    // Get the pre-calculated chart value
                    const chartValue = severityLocationWeights[severityKey] && severityLocationWeights[severityKey][locationKey];
                    
                    if (!chartValue) {
                        console.log('‚ö†Ô∏è No chart value found for', severityKey, locationKey);
                        return 0;
                    }

                    // Get sample size for the total units
                    const sampleSize = getSampleSize(totalUnits);
                    
                    console.log('Chart lookup:', {
                        severity: severityKey, location: locationKey, chartValue, sampleSize
                    });
                    
                    // CORRECT CALCULATION: Only divide chart value by sample size
                    const points = chartValue / sampleSize;
                    
                    console.log(`Calculation: ${chartValue} √∑ ${sampleSize} = ${points}`);
                    
                    const finalPoints = Math.round(points * 100) / 100;
                    console.log('Final points:', finalPoints);
                    
                    return finalPoints; // Round to 2 decimal places
                }

                function formatPointsDisplay(points) {
                    if (points === 0) return "0 points";
                    if (points === 1) return "1 point";
                    return `${points} points`;
                }

                function getSeverityDisplayText(severity) {
                    if (!severity) return '';
                    const s = severity.toLowerCase();
                    if (s.includes('life')) return 'LT';
                    return severity;
                }
                
                function getSeverityClass(severity) {
                    if (!severity) return '';
                    const s = severity.toLowerCase();
                    if (s === 'low') return 'severity-low';
                    if (s === 'moderate') return 'severity-moderate';
                    if (s === 'severe') return 'severity-severe';
                    if (s.includes('life')) return 'severity-life-threatening';
                    return '';
                }
                
                function getSeverityTextClass(severity) {
                    if (!severity) return '';
                    const s = severity.toLowerCase();
                    if (s === 'low') return 'severity-text-low';
                    if (s === 'moderate') return 'severity-text-moderate';
                    if (s === 'severe') return 'severity-text-severe';
                    if (s.includes('life')) return 'severity-text-life-threatening';
                    return '';
                }
                
                function getHcvTextClass(hcv) {
                    if (!hcv) return '';
                    const h = hcv.toLowerCase();
                    if (h === 'pass') return 'hcv-text-pass';
                    if (h === 'fail') return 'hcv-text-fail';
                    return '';
                }
                
            function getHcvClass(hcv) {
                if (!hcv) return '';
                const h = hcv.toLowerCase();
                if (h === 'pass') return 'hcv-pass';
                if (h === 'fail') return 'hcv-fail';
                return '';
            }
            if (currentStandard.deficiencies && currentStandard.deficiencies.length > 0) {
                currentStandard.deficiencies.forEach((def, index) => {
                        let hcv = def.hcv;
                        if (!hcv || hcv === 'Not specified') {
                            if (def.severity) {
                                const s = def.severity.toLowerCase();
                                if (s === 'low') hcv = 'PASS';
                                else if (s === 'moderate' || s === 'severe' || s.includes('life')) hcv = 'FAIL';
                            } else {
                                hcv = 'FAIL';
                            }
                        }
                        // Helpers to compute per-location score labels
                        const totalUnitsVal = localStorage.getItem('totalUnits') || document.getElementById('unitsInput')?.value || '1';
                        const sampleSizeForUI = getSampleSize(totalUnitsVal);
                        // Remove score dependencies to keep UI simple
                        const locScore = () => 0;

                        // Parse severityCellText for location-based severity labels
                        let locationLabels = '';
                        if (def.severityCellText) {
                            const lines = def.severityCellText.split('\n').filter(l => l.trim());
                            let locationGroups = [];
                            lines.forEach(line => {
                                const sevMatch = line.match(/(LOW|MODERATE|SEVERE|LIFE THREATENING)[^\n]*/i);
                                const locMatch = line.match(/\(([^)]+)\)/);
                                const hcvMatch = line.match(/HCV:\s*(PASS|FAIL)/i);
                                if (sevMatch && locMatch) {
                                    const sev = sevMatch[1];
                                    const locs = locMatch[1].split(/\s*&\s*|\s*,\s*/);
                                    const hcvVal = hcvMatch ? hcvMatch[1].toUpperCase() : hcv;
                                    const sevClass = getSeverityClass(sev);
                                    const hcvClassLabel = getHcvClass(hcvVal);
                                    locs.forEach(loc => {
                                        const scoreVal = locScore(sev, loc);
                                        locationGroups.push({
                                            location: loc.trim(),
                                            severity: sev,
                                            severityClass: sevClass,
                                            hcv: hcvVal,
                                            hcvClass: hcvClassLabel,
                        score: scoreVal
                                        });
                                    });
                                }
                            });
                            if (locationGroups.length > 0) {
                                const totalUnits = parseInt(localStorage.getItem('totalUnits') || document.getElementById('unitsInput')?.value || '1', 10);
                                locationGroups.forEach(group => {
                                    // Calculate points for this specific location/severity combination
                                    const groupPointsLost = calculatePointsLostForGroup(group.severity, group.location, totalUnits);
                                    const groupPointsDisplay = formatPointsDisplay(groupPointsLost);
                                    
                                    locationLabels += `<div>
                                        <strong>Location:</strong> <strong class='area-label'>${group.location}</strong> 
                                        <span class='${getSeverityTextClass(group.severity)}'>${getSeverityDisplayText(group.severity)}</span> 
                                        <strong>HCV:</strong> <span class='${getHcvTextClass(group.hcv)}'>${group.hcv}</span>
                                        <span class="points-lost-inline"><strong>Points Lost:</strong> <strong>${groupPointsDisplay}</strong></span>
                                    </div>`;
                                });
                            }
                        }
                        // Fallback single line with a score if no grouped labels
                        let fallbackLocationLine = '';
                        if (!locationLabels) {
                            const sevForFallback = def.severity || 'LOW';
                            const sevClassFallback = getSeverityClass(sevForFallback);
                            const rawLoc = currentStandard.location || '';
                            const firstLoc = rawLoc ? rawLoc.split(/\s*\/\s*/)[0].replace(/\s*UNIT\s*/i, 'UNIT').trim() : (def.location || 'UNIT');
                            
                            // Calculate points for fallback location/severity
                            const totalUnits = parseInt(localStorage.getItem('totalUnits') || document.getElementById('unitsInput')?.value || '1', 10);
                            const fallbackPointsLost = calculatePointsLostForGroup(sevForFallback, def.location || 'UNIT', totalUnits);
                            const fallbackPointsDisplay = formatPointsDisplay(fallbackPointsLost);
                            
                            fallbackLocationLine = `<div>
                                <strong>Location:</strong> <strong class='area-label'>${def.location || ''}</strong> 
                                <span class='${getSeverityTextClass(sevForFallback)}'>${getSeverityDisplayText(sevForFallback)}</span> 
                                <strong>HCV:</strong> <span class='${getHcvTextClass(hcv)}'>${hcv}</span>
                                <span class="points-lost-inline"><strong>Points Lost:</strong> <strong>${fallbackPointsDisplay}</strong></span>
                            </div>`;
                        }
                        
                        deficienciesHtml += `
                            <div class="deficiency-item">
                                <div class="deficiency-criteria-title">
                                    <strong>${def.title || def.id}</strong>

                                </div>
                                <div class="deficiency-meta">
                                    ${locationLabels || fallbackLocationLine}
                                    <div><strong>Correction Time:</strong> ${def.correctionTime || 'Not specified'}</div>
                                </div>
                                <div class="deficiency-details">
                                    <div class="details-title">Details</div>
                                    <div class="deficiency-text">${def.verbatim || ''}</div>
                                </div>
                                <div class="image-section">
                                    <div class="image-section-title">Reference Images:</div>
                                    <div class="image-gallery">
                                        ${generateImagePlaceholders(def.id)}
                                    </div>
                                </div>
                            </div>
                        `;
                });
            }
            details.innerHTML = `
                <div class="deficiency-header">
                    <div class="deficiency-title">${currentStandard.title || currentStandard.id}</div>
                    <div class="deficiency-meta">
                        <div><strong>Location:</strong> ${currentStandard.location || 'Not specified'}</div>
                        <div><strong>Summary:</strong> ${currentStandard.summary || 'Not specified'}</div>
                        <div><strong>Total Deficiencies:</strong> ${currentStandard.deficiencies ? currentStandard.deficiencies.length : 0}</div>
                    </div>
                </div>
                ${deficienciesHtml}
            `;
        }

        function generateImagePlaceholders(deficiencyId) {
            let html = '';
            for (let slot = 1; slot <= 3; slot++) {
                const assignmentKey = `${deficiencyId}_${slot}`;
                
                // Check if assignment exists
                const assignment = imageAssignments.get(assignmentKey);
                
                console.log(`Checking ${assignmentKey}:`, assignment); // Debug log
                
                if (assignment && assignment.outputPath) {
                    // Use the image source directly (now supports both file paths and base64 data URLs)
                    const imageSrc = assignment.outputPath;
                    
                    console.log(`Using image source: ${imageSrc.substring(0, 50)}...`); // Debug log (truncated for base64)
                    html += `<div class="image-placeholder assigned" onclick="showImage('${assignmentKey}')">
                        <img src="${imageSrc}" alt="${assignment.description}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<span>Image Error</span>';">
                    </div>`;
                } else {
                    // Show empty placeholder
                    console.log(`No assignment found for ${assignmentKey}`); // Debug log
                    html += `<div class="image-placeholder empty" onclick="showImage('${assignmentKey}')">
                        <span>Image ${slot}</span>
                    </div>`;
                }
            }
            return html;
        }

        function showImage(imageKey) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            // Check if this is an assigned image
            const assignment = imageAssignments.get(imageKey);
            
            if (assignment && assignment.outputPath) {
                // Use the image source directly (supports both file paths and base64 data URLs)
                modalImg.src = assignment.outputPath;
                modalImg.onerror = function() {
                    this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect width="400" height="300" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="20"%3EAssigned Image Not Found%3C/text%3E%3C/svg%3E';
                };
            } else {
                // Try legacy path format for backward compatibility
                const imagePath = `images/${imageKey}.jpg`;
                modalImg.src = imagePath;
                modalImg.onerror = function() {
                    this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect width="400" height="300" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23999" font-size="20"%3EImage Not Available%3C/text%3E%3C/svg%3E';
                };
            }
            
            modal.classList.add('active');
        }

        function closeImageModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('imageModal').classList.remove('active');
            }
        }

        // Initialize the app
        window.onload = function() {
            // Initialize GHL systems first
            initializeSession();
            initializeOfflineSupport();
            
            // Load weights and sampling data first
            loadWeightsAndSampling();
            
            // Restore total units from localStorage
            const unitsEl = document.getElementById('unitsInput');
            const savedUnits = localStorage.getItem('totalUnits');
            if (unitsEl) {
                unitsEl.value = savedUnits || '';
                unitsEl.addEventListener('input', (e) => {
                    const v = parseInt(e.target.value || '0', 10);
                    if (v > 0) {
                        localStorage.setItem('totalUnits', String(v));
                    }
                    // Update sample size note
                    const note = document.getElementById('sampleSizeNote');
                    if (note) {
                        const sample = (function() {
                            const tv = e.target.value || savedUnits || '1';
                            if (!hudSamplingTable) return 1;
                            const n = Math.max(1, parseInt(tv || '1', 10) || 1);
                            for (const row of hudSamplingTable) {
                                const min = row.min ?? 1, max = row.max;
                                if (n >= min && (max == null || n <= max)) return row.sample || 1;
                            }
                            return 1;
                        })();
                        note.textContent = `Sample size: ${sample}`;
                    }
                    // Re-render badges if details page is visible
                    const detailsVisible = document.getElementById('detailsPage')?.classList.contains('active');
                    if (detailsVisible && weightsData) {
                        displayDeficiencyDetails(); // This will recalculate points with new sample size
                    }
                });
                // Initial sample size note
                const initialNote = document.getElementById('sampleSizeNote');
                if (initialNote) {
                    const tv = unitsEl.value || savedUnits || '1';
                    const n = Math.max(1, parseInt(tv || '1', 10) || 1);
                    let sampleInit = 1;
                    if (Array.isArray(hudSamplingTable)) {
                        for (const row of hudSamplingTable) {
                            const min = row.min ?? 1, max = row.max;
                            if (n >= min && (max == null || n <= max)) { sampleInit = row.sample || 1; break; }
                        }
                    }
                    initialNote.textContent = `Sample size: ${sampleInit}`;
                }
            }

            // Save user session on app state changes
            if (currentUser) {
                saveUserSession();
            }

            // PWA Installation Logic - COMPLETELY REMOVED
            // All PWA code disabled to prevent any notifications
        };
    </script>
</body>
</html>